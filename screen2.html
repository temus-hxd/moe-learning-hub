<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Isaac's Academy - Interactive Learning</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- Configuration script -->
    <script src="/js/config.js"></script>

    <!-- External CSS - AFTER Tailwind so our styles take precedence -->
    <link rel="stylesheet" href="/css/styles.css" />
    <!-- Theme CSS - Load light mode by default -->
    <link rel="stylesheet" href="/css/light-mode.css" id="theme-css" />
  </head>
  <body>
    <div class="flex h-screen desktop-layout">
      <!-- Main Content Area -->
      <div class="flex-1 overflow-y-auto">
        <!-- Header -->
        <header class="p-6 border-b border-white/10">
          <div class="flex items-center justify-between">
            <a
              href="index.html"
              class="flex items-center space-x-4 hover:opacity-90 transition-opacity"
              title="Back to Dashboard"
              aria-label="Back to Dashboard"
            >
              <div
                class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"
              >
                <i data-lucide="graduation-cap" class="w-7 h-7 text-white"></i>
              </div>
              <div>
                <h1 class="text-2xl font-bold">MOE Learning Buddy</h1>
                <p class="text-sm text-gray-400">
                  Interactive Science Learning
                </p>
              </div>
            </a>

            <!-- User Info -->
            <div class="flex items-center space-x-4">
              <!-- Theme Toggle -->
              <button
                id="themeToggle"
                class="btn btn-ghost btn-icon"
                title="Toggle Light/Dark Mode"
              >
                <i data-lucide="sun" class="w-4 h-4 theme-icon-light"></i>
                <i
                  data-lucide="moon"
                  class="w-4 h-4 theme-icon-dark hidden"
                ></i>
              </button>
              <a
                href="screen4b.html"
                class="btn btn-outline"
                title="Share with Peers"
              >
                <i data-lucide="share-2" class="w-4 h-4"></i>
                Share
              </a>
              <a
                href="index.html"
                class="btn btn-secondary hidden md:inline-flex"
                title="Back to Dashboard"
              >
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Dashboard</span>
              </a>
              <div class="text-right">
                <p class="font-bold">Isaac Chen</p>
                <p class="text-sm text-gray-400">Level 7 ‚Ä¢ 1,285 XP</p>
              </div>
              <div class="w-12 h-12 rounded-full overflow-hidden">
                <img
                  src="/img/isaac-photo.png"
                  alt="Isaac Chen"
                  class="w-full h-full object-cover"
                />
              </div>
            </div>
          </div>
        </header>

        <!-- Progress Bar -->
        <div
          class="z-10 p-6 border-b border-white/10 sticky top-0 backdrop-blur supports-[backdrop-filter]:bg-white/5/10"
        >
          <div class="flex justify-between items-center mb-2">
            <span class="font-semibold"
              >Lesson Progress: Advanced Cell Biology</span
            >
            <span class="font-bold text-blue-400" id="lessonProgress"
              >Section 2 of 5</span
            >
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="lessonProgressFill"
              style="width: 40%"
            ></div>
          </div>
        </div>

        <!-- Interactive Learning Content -->
        <main class="p-6 space-y-6">
          <!-- Current Lesson Section -->
          <div class="academy-card p-8" id="lessonSection">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center space-x-4">
                <div
                  class="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center"
                >
                  <i data-lucide="microscope" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                  <h2 class="text-3xl font-bold mb-2">
                    Cellular Organelles & Functions
                  </h2>
                  <p class="text-xl text-gray-300">
                    Discover the powerhouses and factories inside every cell
                  </p>
                </div>
              </div>
              <button class="btn btn-success" id="openNotebook">
                <i data-lucide="notebook-text" class="w-4 h-4"></i> Review Notes
              </button>
            </div>

            <!-- Lesson Content -->
            <div class="lesson-content">
              <!-- Section 1: Introduction -->
              <div class="lesson-section">
                <h3 class="text-2xl font-bold mb-4">
                  Understanding Cell Structure
                </h3>
                <p class="text-lg text-gray-200 mb-4 leading-relaxed">
                  Think of a cell like a bustling city, where each organelle has
                  a specific job to keep the city running smoothly. Just as a
                  city has power plants, factories, and transportation systems,
                  cells have specialized structures that perform essential
                  functions for life.
                </p>

                <!-- Interactive Note-Taking Area -->
                <div class="note-taking-area" id="notesArea">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-blue-400">
                      üìù Your Notes
                    </h4>
                    <button class="btn btn-secondary" id="addNoteBtn">
                      <i data-lucide="plus" class="w-4 h-4"></i>
                      Add Note
                    </button>
                  </div>
                  <div id="notesList" class="space-y-2">
                    <!-- Notes will be added here -->
                  </div>
                </div>
              </div>

              <!-- Section 2: Interactive Concept Mapping -->
              <div class="lesson-section">
                <h3 class="text-2xl font-bold mb-4">
                  Match Organelles to Functions
                </h3>
                <p class="text-gray-200 mb-4">
                  Click on each organelle card to learn about its function, then
                  drag it to the correct function box!
                </p>

                <!-- Organelle Cards (Draggable) -->
                <div class="concept-grid mb-8">
                  <div
                    class="concept-card"
                    data-organelle="mitochondria"
                    draggable="true"
                  >
                    <i
                      data-lucide="zap"
                      class="w-8 h-8 text-yellow-400 mx-auto mb-3"
                    ></i>
                    <h4 class="text-lg font-bold mb-2">Mitochondria</h4>
                    <p class="text-sm text-gray-300">
                      The "powerhouse of the cell"
                    </p>
                  </div>

                  <div
                    class="concept-card"
                    data-organelle="nucleus"
                    draggable="true"
                  >
                    <i
                      data-lucide="command"
                      class="w-8 h-8 text-blue-400 mx-auto mb-3"
                    ></i>
                    <h4 class="text-lg font-bold mb-2">Nucleus</h4>
                    <p class="text-sm text-gray-300">
                      Control center of the cell
                    </p>
                  </div>

                  <div
                    class="concept-card"
                    data-organelle="ribosome"
                    draggable="true"
                  >
                    <i
                      data-lucide="cpu"
                      class="w-8 h-8 text-green-400 mx-auto mb-3"
                    ></i>
                    <h4 class="text-lg font-bold mb-2">Ribosomes</h4>
                    <p class="text-sm text-gray-300">
                      Protein manufacturing sites
                    </p>
                  </div>

                  <div
                    class="concept-card"
                    data-organelle="er"
                    draggable="true"
                  >
                    <i
                      data-lucide="truck"
                      class="w-8 h-8 text-purple-400 mx-auto mb-3"
                    ></i>
                    <h4 class="text-lg font-bold mb-2">
                      Endoplasmic Reticulum
                    </h4>
                    <p class="text-sm text-gray-300">Transportation network</p>
                  </div>
                </div>

                <!-- Function Boxes (Drop Zones) -->
                <div class="mt-6">
                  <h4 class="text-xl font-bold mb-4 text-center">
                    Drag organelles to their functions:
                  </h4>
                  <div class="function-grid">
                    <div
                      class="function-box"
                      data-function="transport"
                      data-correct-organelle="er"
                    >
                      <i
                        data-lucide="truck"
                        class="w-8 h-8 text-purple-400 mb-2"
                      ></i>
                      <h4 class="text-lg font-bold mb-2">
                        Transports Materials
                      </h4>
                      <p class="text-sm text-gray-400">
                        Drop the organelle that moves substances around
                      </p>
                    </div>
                    <div
                      class="function-box"
                      data-function="protein"
                      data-correct-organelle="ribosome"
                    >
                      <i
                        data-lucide="cpu"
                        class="w-8 h-8 text-green-400 mb-2"
                      ></i>
                      <h4 class="text-lg font-bold mb-2">Makes Proteins</h4>
                      <p class="text-sm text-gray-400">
                        Drop the organelle that assembles amino acids
                      </p>
                    </div>
                    <div
                      class="function-box"
                      data-function="control"
                      data-correct-organelle="nucleus"
                    >
                      <i
                        data-lucide="command"
                        class="w-8 h-8 text-blue-400 mb-2"
                      ></i>
                      <h4 class="text-lg font-bold mb-2">
                        Controls Cell Activities
                      </h4>
                      <p class="text-sm text-gray-400">
                        Drop the organelle that contains DNA
                      </p>
                    </div>
                    <div
                      class="function-box"
                      data-function="energy"
                      data-correct-organelle="mitochondria"
                    >
                      <i
                        data-lucide="battery"
                        class="w-8 h-8 text-yellow-400 mb-2"
                      ></i>
                      <h4 class="text-lg font-bold mb-2">
                        Produces Energy (ATP)
                      </h4>
                      <p class="text-sm text-gray-400">
                        Drop the organelle that powers the cell
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Completion Message -->
                <div
                  id="matchingComplete"
                  class="hidden mt-6 p-4 bg-green-500/20 border border-green-500/40 rounded-lg text-center"
                >
                  <i
                    data-lucide="check-circle"
                    class="w-8 h-8 text-green-400 mx-auto mb-2"
                  ></i>
                  <p class="text-lg font-bold text-green-400">
                    üéâ Excellent! You've matched all organelles correctly!
                  </p>
                </div>
              </div>

              <!-- Section 3: Comprehension Check -->
              <div class="lesson-section">
                <div class="quiz-container">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">Quick Knowledge Check</h3>
                    <span
                      class="text-sm text-gray-400"
                      id="questionCounter"
                    ></span>
                  </div>

                  <!-- Question Content -->
                  <div id="quizContent">
                    <!-- Questions will be dynamically loaded here -->
                  </div>

                  <!-- Navigation -->
                  <div class="mt-6 flex justify-between items-center">
                    <button
                      class="btn btn-secondary"
                      id="prevQuestionBtn"
                      style="display: none"
                    >
                      <i data-lucide="arrow-left" class="w-4 h-4"></i>
                      Previous
                    </button>
                    <div class="flex-1"></div>
                    <div class="flex items-center space-x-3">
                      <button
                        class="btn btn-primary"
                        id="checkAnswerBtn"
                        disabled
                      >
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Check Answer
                      </button>
                      <button
                        class="btn btn-primary"
                        id="nextQuestionBtn"
                        style="display: none"
                      >
                        Next
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between items-center mt-8">
              <button class="btn btn-secondary" id="prevSectionBtn">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Previous Section
              </button>

              <div class="flex space-x-3">
                <button class="btn btn-neutral" id="saveProgressBtn">
                  <i data-lucide="bookmark" class="w-4 h-4"></i>
                  Save Progress
                </button>
                <button class="btn btn-primary" id="nextSectionBtn">
                  <span>Next Section</span>
                  <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Enhanced Chat Sidebar -->
      <div class="w-80 chat-area flex flex-col">
        <!-- Chat Header -->
        <div class="p-4 border-b border-white/10">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"
            >
              <i data-lucide="bot" class="w-5 h-5 text-white"></i>
            </div>
            <div>
              <h4 class="font-bold">MOE Buddy</h4>
              <p class="text-xs text-green-400">üü¢ Online ‚Ä¢ Learning Mode</p>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 flex flex-col overflow-hidden">
          <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="flex justify-start mb-4">
              <div class="flex items-start space-x-3">
                <div
                  class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"
                >
                  <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="chat-message">
                  <p class="text-sm text-white">
                    üî¨ Welcome to Advanced Cell Biology, Isaac! I'm here to help
                    you understand these amazing cellular structures.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Action Buttons -->
          <div
            id="quickActions"
            class="px-4 pb-2 space-y-2 border-t border-white/10 pt-3"
          >
            <button
              class="btn btn-ghost w-full justify-center"
              data-message="Explain the difference between mitochondria and nucleus"
            >
              üî¨ Compare mitochondria vs nucleus
            </button>
            <button
              class="btn btn-ghost w-full justify-center"
              data-message="Help me understand protein synthesis in ribosomes"
            >
              ‚öôÔ∏è Explain protein synthesis
            </button>
            <button
              class="btn btn-ghost w-full justify-center"
              data-message="What are good memory techniques for remembering organelles?"
            >
              üß† Memory techniques
            </button>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-white/10">
          <div class="flex space-x-3">
            <textarea
              id="chatInput"
              rows="1"
              placeholder="Ask about cell organelles..."
              enterkeyhint="send"
              class="flex-1 bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-400 transition-colors resize-none max-h-32 leading-5 whitespace-pre-wrap break-words"
            ></textarea>
            <button id="sendMessage" class="btn btn-primary btn-icon">
              <i data-lucide="send" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reusable Glass Modal -->
    <div
      id="glassModal"
      class="glass-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="glassModalTitle"
      aria-hidden="true"
    >
      <div class="glass-modal">
        <div class="glass-modal-header">
          <div class="flex items-center gap-2">
            <i data-lucide="help-circle" class="w-5 h-5 text-blue-300"></i>
            <h3 id="glassModalTitle" class="text-lg font-semibold">
              AI Learning Assistant
            </h3>
          </div>
          <button id="glassClose" class="glass-close">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div id="glassBody" class="glass-modal-body"></div>
        <div class="glass-modal-footer">
          <button id="glassOk" class="btn btn-primary w-full">
            <i data-lucide="check" class="w-4 h-4"></i>
            Got it, thanks!
          </button>
        </div>
      </div>
    </div>

    <!-- Add Note Modal -->
    <div
      id="noteModal"
      class="glass-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="noteModalTitle"
      aria-hidden="true"
    >
      <div
        class="glass-modal"
        style="
          width: min(90vw, 600px);
          height: min(85vh, 600px);
          display: flex;
          flex-direction: column;
        "
      >
        <div class="glass-modal-header">
          <div class="flex items-center gap-2">
            <i data-lucide="edit-3" class="w-5 h-5"></i>
            <h3 id="noteModalTitle" class="text-lg font-semibold">Add Note</h3>
          </div>
          <button id="closeNoteModal" class="glass-close">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div
          class="glass-modal-body"
          style="
            display: flex;
            flex-direction: column;
            height: calc(100% - 140px);
            padding-bottom: 8px;
          "
        >
          <p class="text-white/80 text-sm mb-3">
            Write your notes about cellular organelles. Use markdown for
            formatting!
          </p>
          <textarea
            id="noteInput"
            placeholder="## My Notes on Cell Biology&#10;&#10;**Key Points:**&#10;- Mitochondria = powerhouse&#10;- Nucleus = control center&#10;&#10;*Add your thoughts here...*"
            class="flex-1 w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-sm text-white resize-none outline-none focus:border-blue-400 transition-colors font-mono"
            style="
              min-height: 250px;
              font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
              line-height: 1.5;
            "
          ></textarea>
        </div>
        <div
          class="glass-modal-footer"
          style="
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 20px;
            margin-top: auto;
          "
        >
          <button id="cancelNote" class="btn btn-secondary">
            <i data-lucide="x" class="w-4 h-4"></i>
            Cancel
          </button>
          <button id="saveNote" class="btn btn-primary">
            <i data-lucide="save" class="w-4 h-4"></i>
            Save Note
          </button>
        </div>
      </div>
    </div>

    <!-- Notebook Glass Modal -->
    <div
      id="notebookOverlay"
      class="glass-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="notebookTitle"
      aria-hidden="true"
    >
      <div
        class="glass-modal"
        style="
          width: min(96vw, 1100px);
          height: min(92vh, 760px);
          display: flex;
          flex-direction: column;
        "
      >
        <div class="glass-modal-header">
          <div class="flex items-center gap-2">
            <i data-lucide="notebook-text" class="w-5 h-5"></i>
            <h3 id="notebookTitle" class="text-lg font-semibold">
              Advanced Cell Biology Notes
            </h3>
          </div>
          <button id="closeNotebook" class="glass-close">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div
          class="glass-modal-body"
          style="
            display: flex;
            gap: 16px;
            flex: 1;
            overflow: hidden;
            padding: 16px 20px;
          "
        >
          <div
            class="glass-col"
            style="flex: 2; overflow-y: auto; padding-right: 8px"
          >
            <h4 class="text-xl font-bold mb-3">Lecture: Organelles at Work</h4>
            <p class="text-white/85 mb-3">
              Use this mini‚Äëlecture as a map of who does what inside cells. Link
              each organelle to its job and to the energy/materials it needs.
            </p>
            <div class="mermaid mb-4">
              flowchart TB N["Nucleus\nDNA & Control"] -->|mRNA|
              R["Ribosome\nProtein Assembly"] R --> ER["Rough
              ER\nFolding/Transport"] ER --> G["Golgi\nPackaging"]
              M["Mitochondria\nATP from Respiration"] --> E((ATP)) E --> R E -->
              ActiveTransport["Active Transport"] SER["Smooth ER\nLipids/Detox"]
            </div>
            <div class="mermaid mb-4">
              sequenceDiagram participant N as Nucleus participant R as Ribosome
              participant ER as Rough ER participant G as Golgi N->>R: mRNA
              instructions R->>ER: nascent protein ER->>G: folded protein in
              vesicle G-->>Cell: labeled protein to destination
            </div>
            <ul class="list-disc pl-5 space-y-1 text-white/85">
              <li>Ribosomes read mRNA and stitch amino acids into proteins.</li>
              <li>
                Rough ER helps fold/modify proteins; Smooth ER builds lipids and
                detoxifies.
              </li>
              <li>
                Mitochondria provide ATP to power synthesis and transport steps.
              </li>
              <li>Golgi tags and ships proteins to where they are needed.</li>
            </ul>
          </div>
          <div
            class="glass-col"
            style="
              flex: 1;
              display: flex;
              flex-direction: column;
              min-height: 0;
            "
          >
            <h4 class="text-lg font-semibold mb-2">Isaac's Notes</h4>
            <textarea
              class="notes-textarea"
              placeholder="Write your notes here..."
              style="
                flex: 1;
                min-height: 300px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                padding: 12px;
                color: white;
                font-family: 'Monaco', monospace;
                font-size: 13px;
                line-height: 1.5;
                resize: none;
                outline: none;
              "
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Mermaid init - will be reinitialized with correct theme
      if (window.mermaid) {
        mermaid.initialize({ startOnLoad: false, theme: "dark" });
      }
      // Initialize Lucide icons
      lucide.createIcons();

      // Theme Toggle Functionality
      const themeToggle = document.getElementById("themeToggle");
      const themeCss = document.getElementById("theme-css");
      const themeIconLight = document.querySelector(".theme-icon-light");
      const themeIconDark = document.querySelector(".theme-icon-dark");

      // Get current theme from localStorage or default to dark
      let currentTheme = localStorage.getItem("theme") || "light";

      // Apply initial theme
      function setTheme(theme) {
        currentTheme = theme;
        localStorage.setItem("theme", theme);

        if (theme === "light") {
          themeCss.href = "css/light-mode.css";
          themeIconLight.classList.add("hidden");
          themeIconDark.classList.remove("hidden");
          document.body.setAttribute("data-theme", "light");

          // Update Mermaid theme
          if (window.mermaid) {
            mermaid.initialize({ startOnLoad: false, theme: "default" });
          }
        } else {
          themeCss.href = "css/dark-mode.css";
          themeIconLight.classList.remove("hidden");
          themeIconDark.classList.add("hidden");
          document.body.setAttribute("data-theme", "dark");

          // Update Mermaid theme
          if (window.mermaid) {
            mermaid.initialize({ startOnLoad: false, theme: "dark" });
          }
        }
      }

      // Set initial theme
      setTheme(currentTheme);

      // Theme toggle click handler
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          setTheme(newTheme);
        });
      }

      // Screen 2 Interactive Learning
      class Screen2InteractiveLearning {
        constructor() {
          this.currentSection = 2;
          this.totalSections = 5;
          this.selectedQuizAnswer = null;
          this.notes = [];
          this.conceptsMatched = 0;
          this.matchedPairs = {}; // Track matched organelle-function pairs
          this.totalMatches = 4; // Total number of matches needed
          this.currentQuestionIndex = 0;
          this.quizQuestions = [
            {
              question:
                "Which organelle is responsible for producing ATP (energy) for the cell?",
              options: [
                {
                  text: "Mitochondria",
                  icon: "zap",
                  color: "yellow-400",
                  correct: true,
                },
                {
                  text: "Nucleus",
                  icon: "command",
                  color: "blue-400",
                  correct: false,
                },
                {
                  text: "Ribosomes",
                  icon: "cpu",
                  color: "green-400",
                  correct: false,
                },
              ],
              correctFeedback:
                "üéâ Correct! Mitochondria are the powerhouses of the cell!",
              incorrectFeedback:
                "üí° Not quite right. Mitochondria produce ATP energy for the cell.",
            },
            {
              question: "What is the main function of the nucleus in a cell?",
              options: [
                {
                  text: "Produces energy",
                  icon: "zap",
                  color: "yellow-400",
                  correct: false,
                },
                {
                  text: "Controls cell activities and contains DNA",
                  icon: "command",
                  color: "blue-400",
                  correct: true,
                },
                {
                  text: "Makes proteins",
                  icon: "cpu",
                  color: "green-400",
                  correct: false,
                },
                {
                  text: "Transports materials",
                  icon: "truck",
                  color: "purple-400",
                  correct: false,
                },
              ],
              correctFeedback:
                "üéâ Excellent! The nucleus is the control center containing DNA!",
              incorrectFeedback:
                "üí° The nucleus controls cell activities and stores genetic material (DNA).",
            },
            {
              question: "Which organelle is responsible for protein synthesis?",
              options: [
                {
                  text: "Mitochondria",
                  icon: "zap",
                  color: "yellow-400",
                  correct: false,
                },
                {
                  text: "Nucleus",
                  icon: "command",
                  color: "blue-400",
                  correct: false,
                },
                {
                  text: "Ribosomes",
                  icon: "cpu",
                  color: "green-400",
                  correct: true,
                },
                {
                  text: "Endoplasmic Reticulum",
                  icon: "truck",
                  color: "purple-400",
                  correct: false,
                },
              ],
              correctFeedback:
                "üéâ Perfect! Ribosomes assemble amino acids into proteins!",
              incorrectFeedback:
                "üí° Ribosomes are the protein-making factories that read mRNA and assemble proteins.",
            },
            {
              question:
                "What is the primary role of the Endoplasmic Reticulum?",
              options: [
                {
                  text: "Energy production",
                  icon: "zap",
                  color: "yellow-400",
                  correct: false,
                },
                {
                  text: "Protein synthesis",
                  icon: "cpu",
                  color: "green-400",
                  correct: false,
                },
                {
                  text: "Transporting and processing materials",
                  icon: "truck",
                  color: "purple-400",
                  correct: true,
                },
                {
                  text: "Storing genetic information",
                  icon: "command",
                  color: "blue-400",
                  correct: false,
                },
              ],
              correctFeedback:
                "üéâ Great! The ER transports materials and processes proteins!",
              incorrectFeedback:
                "üí° The Endoplasmic Reticulum is a transportation network that moves materials throughout the cell.",
            },
            {
              question:
                "Which organelle contains its own DNA and is thought to have evolved from ancient bacteria?",
              options: [
                {
                  text: "Mitochondria",
                  icon: "zap",
                  color: "yellow-400",
                  correct: true,
                },
                {
                  text: "Nucleus",
                  icon: "command",
                  color: "blue-400",
                  correct: false,
                },
                {
                  text: "Ribosomes",
                  icon: "cpu",
                  color: "green-400",
                  correct: false,
                },
                {
                  text: "Endoplasmic Reticulum",
                  icon: "truck",
                  color: "purple-400",
                  correct: false,
                },
              ],
              correctFeedback:
                "üéâ Amazing! Mitochondria have their own DNA and evolved from symbiotic bacteria!",
              incorrectFeedback:
                "üí° Mitochondria contain their own DNA and are believed to have evolved from ancient bacteria through endosymbiosis.",
            },
          ];
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.setupMOEBuddy();
          this.setupInteractiveElements();
          this.setupNotebook();
          this.setupNoteModal();
          this.loadQuizQuestion();
        }

        setupEventListeners() {
          // Navigation buttons
          document
            .getElementById("nextSectionBtn")
            .addEventListener("click", () => this.nextSection());
          document
            .getElementById("prevSectionBtn")
            .addEventListener("click", () => this.prevSection());
          document
            .getElementById("saveProgressBtn")
            .addEventListener("click", () => this.saveProgress());

          // Note taking
          document
            .getElementById("addNoteBtn")
            .addEventListener("click", () => this.openNoteModal());

          // Quiz
          document
            .getElementById("checkAnswerBtn")
            .addEventListener("click", () => this.checkQuizAnswer());
          document
            .getElementById("nextQuestionBtn")
            .addEventListener("click", () => this.nextQuestion());
          document
            .getElementById("prevQuestionBtn")
            .addEventListener("click", () => this.prevQuestion());
        }

        setupMOEBuddy() {
          this.moeBuddy = new MOEBuddy();
        }

        setupInteractiveElements() {
          // Concept cards interaction (click to learn)
          const conceptCards = document.querySelectorAll(".concept-card");
          conceptCards.forEach((card) => {
            card.dataset.isDragging = "false";
            card.addEventListener("click", () => this.handleConceptClick(card));
            // Add grab cursor for draggable cards
            if (card.hasAttribute("draggable")) {
              card.style.cursor = "grab";
              card.addEventListener("mousedown", () => {
                card.style.cursor = "grabbing";
              });
              card.addEventListener("mouseup", () => {
                card.style.cursor = "grab";
              });
            }
          });

          // Setup drag and drop for organelle matching
          this.setupDragAndDrop();

          // Quiz options
          const quizOptions = document.querySelectorAll(".quiz-option");
          quizOptions.forEach((option) => {
            option.addEventListener("click", () =>
              this.selectQuizOption(option)
            );
          });
        }

        setupDragAndDrop() {
          const cards = document.querySelectorAll(".concept-card");
          const dropZones = document.querySelectorAll(".function-box");

          // Store original HTML for each function box
          dropZones.forEach((zone) => {
            zone.dataset.originalHtml = zone.innerHTML;
          });

          cards.forEach((card) => {
            card.addEventListener("dragstart", (e) =>
              this.handleDragStart(e, card)
            );
            card.addEventListener("dragend", (e) =>
              this.handleDragEnd(e, card)
            );
          });

          dropZones.forEach((zone) => {
            zone.addEventListener("dragover", (e) => this.handleDragOver(e));
            zone.addEventListener("dragenter", (e) =>
              this.handleDragEnter(e, zone)
            );
            zone.addEventListener("dragleave", (e) =>
              this.handleDragLeave(e, zone)
            );
            zone.addEventListener("drop", (e) => this.handleDrop(e, zone));
          });
        }

        handleDragStart(e, card) {
          e.dataTransfer.setData("text/plain", card.dataset.organelle);
          e.dataTransfer.effectAllowed = "move";
          card.classList.add("dragging");
          card.dataset.isDragging = "true";
        }

        handleDragEnd(e, card) {
          card.classList.remove("dragging");
          // Small delay to prevent click event after drag
          setTimeout(() => {
            card.dataset.isDragging = "false";
          }, 100);
        }

        handleDragOver(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }

        handleDragEnter(e, zone) {
          e.preventDefault();
          if (!zone.classList.contains("filled")) {
            zone.classList.add("drag-over");
          }
        }

        handleDragLeave(e, zone) {
          zone.classList.remove("drag-over");
        }

        handleDrop(e, zone) {
          e.preventDefault();
          zone.classList.remove("drag-over");

          // Check if zone is already filled
          if (zone.classList.contains("filled")) {
            this.showNotification(
              "This function box already has an organelle!",
              "warning"
            );
            return;
          }

          const organelle = e.dataTransfer.getData("text/plain");
          const correctOrganelle = zone.dataset.correctOrganelle;

          // Get the card element
          const card = document.querySelector(
            `.concept-card[data-organelle="${organelle}"]`
          );
          if (!card) return;

          // Check if card is already matched
          if (card.style.opacity === "0.5") {
            this.showNotification(
              "This organelle is already matched!",
              "warning"
            );
            return;
          }

          // Create a visual representation in the drop zone
          const cardClone = card.cloneNode(true);
          cardClone.classList.remove("concept-card", "dragging");
          cardClone.classList.add("matched-organelle");
          cardClone.style.cursor = "default";
          cardClone.style.pointerEvents = "none";

          // Add remove button
          const removeBtn = document.createElement("button");
          removeBtn.className =
            "absolute top-2 right-2 w-6 h-6 bg-red-500/80 hover:bg-red-500 rounded-full flex items-center justify-center text-white text-xs transition-colors";
          removeBtn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
          removeBtn.onclick = (evt) => {
            evt.stopPropagation();
            this.removeMatch(zone, card);
          };

          // Make zone relative for absolute positioning
          zone.style.position = "relative";
          zone.innerHTML = "";
          zone.appendChild(cardClone);
          zone.appendChild(removeBtn);
          lucide.createIcons();

          // Check if match is correct
          const isCorrect = organelle === correctOrganelle;
          if (isCorrect) {
            zone.classList.add("filled");
            zone.style.borderColor = "var(--color-success)";
            zone.style.background = "rgba(16, 185, 129, 0.15)";
            card.style.opacity = "0.5";
            card.style.pointerEvents = "none";
            card.style.cursor = "not-allowed";

            this.conceptsMatched++;
            this.matchedPairs[organelle] = zone.dataset.function;

            this.showNotification(
              `üéâ Correct! ${
                card.querySelector("h4").textContent
              } matches this function!`,
              "success"
            );

            // Check if all matches are complete
            if (this.conceptsMatched === this.totalMatches) {
              this.showMatchingComplete();
            }
          } else {
            // Wrong match - show feedback and remove after delay
            zone.style.borderColor = "var(--color-danger)";
            zone.style.background = "rgba(239, 68, 68, 0.15)";

            this.showNotification(`‚ùå Not quite right. Try again!`, "warning");

            setTimeout(() => {
              zone.innerHTML = zone.dataset.originalHtml || "";
              zone.style.borderColor = "";
              zone.style.background = "";
              lucide.createIcons();
            }, 1500);
          }
        }

        removeMatch(zone, originalCard) {
          const functionType = zone.dataset.function;
          const organelle = Object.keys(this.matchedPairs).find(
            (key) => this.matchedPairs[key] === functionType
          );

          if (organelle) {
            delete this.matchedPairs[organelle];
            this.conceptsMatched--;

            // Restore original card
            const card = document.querySelector(
              `.concept-card[data-organelle="${organelle}"]`
            );
            if (card) {
              card.style.opacity = "";
              card.style.pointerEvents = "";
              card.style.cursor = "";
            }
          }

          // Restore zone
          zone.classList.remove("filled");
          zone.style.borderColor = "";
          zone.style.background = "";
          zone.innerHTML = zone.dataset.originalHtml || "";
          lucide.createIcons();

          // Hide completion message if shown
          const completeMsg = document.getElementById("matchingComplete");
          if (completeMsg) {
            completeMsg.classList.add("hidden");
          }
        }

        getFunctionIcon(functionType) {
          const icons = {
            energy: "battery",
            control: "command",
            protein: "cpu",
            transport: "truck",
          };
          return icons[functionType] || "help-circle";
        }

        getFunctionColor(functionType) {
          const colors = {
            energy: "yellow-400",
            control: "blue-400",
            protein: "green-400",
            transport: "purple-400",
          };
          return colors[functionType] || "gray-400";
        }

        getFunctionTitle(functionType) {
          const titles = {
            energy: "Produces Energy (ATP)",
            control: "Controls Cell Activities",
            protein: "Makes Proteins",
            transport: "Transports Materials",
          };
          return titles[functionType] || "";
        }

        getFunctionDescription(functionType) {
          const descriptions = {
            energy: "Drop the organelle that powers the cell",
            control: "Drop the organelle that contains DNA",
            protein: "Drop the organelle that assembles amino acids",
            transport: "Drop the organelle that moves substances around",
          };
          return descriptions[functionType] || "";
        }

        showMatchingComplete() {
          const completeMsg = document.getElementById("matchingComplete");
          if (completeMsg) {
            completeMsg.classList.remove("hidden");
            this.showNotification(
              "üéâ Amazing! You've mastered organelle functions!",
              "success"
            );
          }
        }

        setupNotebook() {
          const openBtn = document.getElementById("openNotebook");
          const overlay = document.getElementById("notebookOverlay");
          const closeBtn = document.getElementById("closeNotebook");
          if (!(openBtn && overlay && closeBtn)) return;
          const renderMermaid = () => {
            if (window.mermaid) {
              const blocks = overlay.querySelectorAll(".mermaid");
              blocks.forEach((b) => b.removeAttribute("data-processed"));
              mermaid.init(undefined, blocks);
            }
          };
          openBtn.addEventListener("click", () => {
            overlay.style.display = "flex";
            renderMermaid();
            lucide.createIcons();
          });
          closeBtn.addEventListener(
            "click",
            () => (overlay.style.display = "none")
          );
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) overlay.style.display = "none";
          });
          document.addEventListener("keydown", function esc(e) {
            if (e.key === "Escape") overlay.style.display = "none";
          });
        }

        setupNoteModal() {
          const noteModal = document.getElementById("noteModal");
          const closeBtn = document.getElementById("closeNoteModal");
          const cancelBtn = document.getElementById("cancelNote");
          const saveBtn = document.getElementById("saveNote");
          const noteInput = document.getElementById("noteInput");

          if (!(noteModal && closeBtn && cancelBtn && saveBtn && noteInput))
            return;

          const closeModal = () => {
            noteModal.style.display = "none";
            noteInput.value = "";
          };

          closeBtn.addEventListener("click", closeModal);
          cancelBtn.addEventListener("click", closeModal);
          saveBtn.addEventListener("click", () => this.saveNoteFromModal());

          // Close on backdrop click
          noteModal.addEventListener("click", (e) => {
            if (e.target === noteModal) closeModal();
          });

          // Close on Escape key
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && noteModal.style.display === "flex") {
              closeModal();
            }
          });
        }

        handleConceptClick(card) {
          // Don't show info if user just finished dragging
          if (card.dataset.isDragging === "true") {
            return;
          }
          const organelle = card.dataset.organelle;
          card.classList.toggle("selected");

          // Show detailed info based on organelle
          const organelleInfo = {
            mitochondria: {
              title: "Mitochondria - The Powerhouse",
              content: `
                            <div class="flex items-start gap-4">
                                <div class="w-32 h-32 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="zap" class="w-16 h-16 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-base text-white mb-3">
                                        Mitochondria are the energy factories of the cell! They convert glucose and oxygen into ATP (energy) 
                                        through a process called cellular respiration.
                                    </p>
                                    <ul class="text-sm text-white/80 space-y-1">
                                        <li>‚Ä¢ Contains its own DNA (ancient bacteria origin)</li>
                                        <li>‚Ä¢ Has double membrane structure with cristae folds</li>
                                        <li>‚Ä¢ More active cells have more mitochondria (muscle cells have thousands)</li>
                                        <li>‚Ä¢ Found in both plant and animal cells</li>
                                        <li>‚Ä¢ Produces about 90% of cellular energy as ATP</li>
                                        <li>‚Ä¢ Inherited maternally - you get yours from your mother!</li>
                                        <li>‚Ä¢ Can reproduce independently within cells</li>
                                        <li>‚Ä¢ Evolved from symbiotic bacteria 1.5 billion years ago</li>
                                        <li>‚Ä¢ Size varies: 0.5-10 micrometers in length</li>
                                        <li>‚Ä¢ Contains enzymes for the Krebs cycle and electron transport</li>
                                        <li>‚Ä¢ Damaged mitochondria are recycled through mitophagy</li>
                                    </ul>
                                </div>
                            </div>
                        `,
            },
            nucleus: {
              title: "Nucleus - The Control Center",
              content: `
                            <div class="flex items-start gap-4">
                                <div class="w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="command" class="w-16 h-16 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-base text-white mb-3">
                                        The nucleus is like the brain of the cell, controlling all cellular activities and containing 
                                        the cell's genetic material (DNA).
                                    </p>
                                    <ul class="text-sm text-white/80 space-y-1">
                                        <li>‚Ä¢ Contains chromosomes with DNA (humans have 46 chromosomes)</li>
                                        <li>‚Ä¢ Controls gene expression and protein synthesis</li>
                                        <li>‚Ä¢ Surrounded by double nuclear membrane with pores</li>
                                        <li>‚Ä¢ Contains the nucleolus (makes ribosomes)</li>
                                        <li>‚Ä¢ Typically 10-20% of cell volume</li>
                                        <li>‚Ä¢ Nuclear pores allow selective transport of molecules</li>
                                        <li>‚Ä¢ DNA is organized with histone proteins into chromatin</li>
                                        <li>‚Ä¢ Disappears during cell division, reforms afterward</li>
                                        <li>‚Ä¢ Missing in prokaryotes (bacteria) - they have nucleoid instead</li>
                                        <li>‚Ä¢ Contains most of the cell's genetic material (99%+)</li>
                                        <li>‚Ä¢ Nuclear envelope connects to endoplasmic reticulum</li>
                                    </ul>
                                </div>
                            </div>
                        `,
            },
            ribosome: {
              title: "Ribosomes - Protein Factories",
              content: `
                            <div class="flex items-start gap-4">
                                <div class="w-32 h-32 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="cpu" class="w-16 h-16 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-base text-white mb-3">
                                        Ribosomes are the protein-making machines of the cell. They read instructions from RNA 
                                        and assemble amino acids into proteins.
                                    </p>
                                    <ul class="text-sm text-white/80 space-y-1">
                                        <li>‚Ä¢ Made of ribosomal RNA (rRNA) and proteins</li>
                                        <li>‚Ä¢ Can be free-floating or attached to rough ER</li>
                                        <li>‚Ä¢ Translate messenger RNA (mRNA) into proteins</li>
                                        <li>‚Ä¢ Essential for protein synthesis in all living cells</li>
                                        <li>‚Ä¢ Consist of large (60S) and small (40S) subunits in eukaryotes</li>
                                        <li>‚Ä¢ Free ribosomes make proteins for internal cell use</li>
                                        <li>‚Ä¢ ER-bound ribosomes make proteins for secretion or membranes</li>
                                        <li>‚Ä¢ Produced in the nucleolus within the nucleus</li>
                                        <li>‚Ä¢ About 20-25 nanometers in diameter</li>
                                        <li>‚Ä¢ Can form polyribosomes (clusters) for efficient production</li>
                                        <li>‚Ä¢ One of the most ancient and conserved cellular components</li>
                                    </ul>
                                </div>
                            </div>
                        `,
            },
            er: {
              title: "Endoplasmic Reticulum - Transport Network",
              content: `
                            <div class="flex items-start gap-4">
                                <div class="w-32 h-32 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="truck" class="w-16 h-16 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-base text-white mb-3">
                                        The ER is like a highway system that transports materials throughout the cell. 
                                        It comes in two types: rough (with ribosomes) and smooth (without ribosomes).
                                    </p>
                                    <ul class="text-sm text-white/80 space-y-1">
                                        <li>‚Ä¢ Rough ER: protein processing, folding, and modification</li>
                                        <li>‚Ä¢ Smooth ER: lipid synthesis, steroid production, and detoxification</li>
                                        <li>‚Ä¢ Connected directly to the nuclear membrane</li>
                                        <li>‚Ä¢ Transports materials via vesicles to Golgi apparatus</li>
                                        <li>‚Ä¢ Extends throughout the cytoplasm as interconnected membranes</li>
                                        <li>‚Ä¢ Rough ER abundant in cells that secrete proteins (antibodies, enzymes)</li>
                                        <li>‚Ä¢ Smooth ER prominent in liver cells for detoxification</li>
                                        <li>‚Ä¢ Stores calcium ions, especially in muscle cells</li>
                                        <li>‚Ä¢ Can be continuous with outer nuclear membrane</li>
                                        <li>‚Ä¢ Helps maintain cell shape and provides structural support</li>
                                        <li>‚Ä¢ Critical for quality control - misfolded proteins are destroyed here</li>
                                    </ul>
                                </div>
                            </div>
                        `,
            },
          };

          if (organelleInfo[organelle]) {
            this.showGlassModal(
              organelleInfo[organelle].title,
              organelleInfo[organelle].content
            );
          }
        }

        loadQuizQuestion() {
          const question = this.quizQuestions[this.currentQuestionIndex];
          const quizContent = document.getElementById("quizContent");
          const questionCounter = document.getElementById("questionCounter");
          const checkBtn = document.getElementById("checkAnswerBtn");
          const nextBtn = document.getElementById("nextQuestionBtn");
          const prevBtn = document.getElementById("prevQuestionBtn");

          // Update counter
          questionCounter.textContent = `Question ${
            this.currentQuestionIndex + 1
          } of ${this.quizQuestions.length}`;

          // Build question HTML
          let optionsHTML = question.options
            .map(
              (opt, idx) => `
            <div class="quiz-option" data-answer="${
              opt.correct ? "correct" : "incorrect"
            }" data-option-index="${idx}">
              <div class="flex items-center space-x-3">
                <i data-lucide="${opt.icon}" class="w-5 h-5 text-${
                opt.color
              }"></i>
                <span>${opt.text}</span>
              </div>
            </div>
          `
            )
            .join("");

          quizContent.innerHTML = `
            <p class="text-lg mb-4">${question.question}</p>
            <div class="space-y-3">${optionsHTML}</div>
          `;

          // Reset state
          this.selectedQuizAnswer = null;
          checkBtn.disabled = true;
          checkBtn.style.display = "inline-flex";
          checkBtn.innerHTML =
            '<i data-lucide="check" class="w-4 h-4"></i> Check Answer';
          checkBtn.onclick = null;

          // Show/hide navigation buttons
          nextBtn.style.display = "none"; // Hidden initially, shown after answer is checked
          prevBtn.style.display =
            this.currentQuestionIndex > 0 ? "inline-flex" : "none";

          // Re-attach event listeners and reset styles
          const quizOptions = document.querySelectorAll(".quiz-option");
          quizOptions.forEach((option) => {
            option.style.pointerEvents = "auto";
            option.classList.remove("selected", "correct", "incorrect");
            option.addEventListener("click", () =>
              this.selectQuizOption(option)
            );
          });

          // Reinitialize icons
          lucide.createIcons();
        }

        selectQuizOption(option) {
          // Don't allow selection if answer already checked
          if (
            document
              .querySelectorAll(".quiz-option")[0]
              ?.classList.contains("correct") ||
            document
              .querySelectorAll(".quiz-option")[0]
              ?.classList.contains("incorrect")
          ) {
            return;
          }

          // Clear previous selections
          document.querySelectorAll(".quiz-option").forEach((opt) => {
            opt.classList.remove("selected");
          });

          option.classList.add("selected");
          this.selectedQuizAnswer = option.dataset.answer;
          document.getElementById("checkAnswerBtn").disabled = false;
        }

        checkQuizAnswer() {
          const question = this.quizQuestions[this.currentQuestionIndex];
          const options = document.querySelectorAll(".quiz-option");
          const checkBtn = document.getElementById("checkAnswerBtn");
          const nextBtn = document.getElementById("nextQuestionBtn");

          // Show correct/incorrect states
          options.forEach((option) => {
            if (option.dataset.answer === "correct") {
              option.classList.add("correct");
            } else {
              option.classList.add("incorrect");
            }
          });

          // Disable further selections
          options.forEach((option) => {
            option.style.pointerEvents = "none";
          });

          // Show feedback
          if (this.selectedQuizAnswer === "correct") {
            this.showNotification(question.correctFeedback, "success");
            this.updateProgress();
          } else {
            this.showNotification(question.incorrectFeedback, "info");
          }

          // Show next button if not last question
          if (this.currentQuestionIndex < this.quizQuestions.length - 1) {
            checkBtn.style.display = "none";
            nextBtn.style.display = "inline-flex";
          } else {
            checkBtn.innerHTML =
              '<i data-lucide="check-circle" class="w-4 h-4"></i> Quiz Complete!';
            checkBtn.disabled = true;
          }
        }

        nextQuestion() {
          if (this.currentQuestionIndex < this.quizQuestions.length - 1) {
            this.currentQuestionIndex++;
            this.loadQuizQuestion();
          }
        }

        prevQuestion() {
          if (this.currentQuestionIndex > 0) {
            this.currentQuestionIndex--;
            this.loadQuizQuestion();
          }
        }

        openNoteModal() {
          const noteModal = document.getElementById("noteModal");
          const noteInput = document.getElementById("noteInput");

          noteModal.style.display = "flex";
          noteInput.focus();
          lucide.createIcons();
        }

        saveNoteFromModal() {
          const noteInput = document.getElementById("noteInput");
          const noteModal = document.getElementById("noteModal");
          const noteText = noteInput.value.trim();

          if (noteText) {
            const note = {
              id: Date.now(),
              text: noteText,
              timestamp: new Date().toLocaleTimeString(),
              isMarkdown: true,
            };

            this.notes.push(note);
            this.renderNote(note);
            this.showNotification("üìù Note saved successfully!", "success");

            // Close modal and clear input
            noteModal.style.display = "none";
            noteInput.value = "";
          } else {
            this.showNotification(
              "‚ö†Ô∏è Please write something before saving!",
              "warning"
            );
          }
        }

        renderNote(note) {
          const notesList = document.getElementById("notesList");
          const noteElement = document.createElement("div");
          noteElement.className = "note-item";

          // Simple markdown parsing for display
          let displayText = note.text;
          if (note.isMarkdown) {
            displayText = this.parseMarkdown(note.text);
          }

          noteElement.innerHTML = `
                    <div class="flex-1">
                        <div class="text-white text-sm markdown-content">${displayText}</div>
                        <p class="text-gray-400 text-xs mt-2">${note.timestamp}</p>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="learning.removeNote(${note.id})">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                `;
          notesList.appendChild(noteElement);
          lucide.createIcons();
        }

        // Simple markdown parser for basic formatting
        parseMarkdown(text) {
          return (
            text
              // Headers
              .replace(
                /^### (.*$)/gim,
                '<h3 class="text-lg font-bold text-yellow-400 mb-1">$1</h3>'
              )
              .replace(
                /^## (.*$)/gim,
                '<h2 class="text-xl font-bold text-blue-400 mb-2">$1</h2>'
              )
              .replace(
                /^# (.*$)/gim,
                '<h1 class="text-2xl font-bold text-white mb-2">$1</h1>'
              )
              // Bold and italic
              .replace(
                /\*\*(.*?)\*\*/g,
                '<strong class="font-bold text-white">$1</strong>'
              )
              .replace(/\*(.*?)\*/g, '<em class="italic text-blue-200">$1</em>')
              // Lists
              .replace(/^- (.*$)/gim, '<li class="ml-4 text-white">‚Ä¢ $1</li>')
              // Line breaks
              .replace(/\n/g, "<br>")
          );
        }

        removeNote(noteId) {
          this.notes = this.notes.filter((note) => note.id !== noteId);
          const noteElement = document
            .querySelector(`[onclick="learning.removeNote(${noteId})"]`)
            .closest(".note-item");
          noteElement.remove();
        }

        showAIHelp() {
          const helpContent = `
                    <div class="space-y-4">
                        <div class="flex items-start gap-4">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i data-lucide="brain" class="w-10 h-10 text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">Learning Strategy Tips</h4>
                                <p class="text-white/90 mb-3">Here are some ways I can help you master cellular biology:</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
                                <h5 class="text-white font-semibold mb-1">üîç Ask Specific Questions</h5>
                                <p class="text-white/80 text-sm">Ask about specific organelles, processes, or comparisons</p>
                            </div>
                            <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3">
                                <h5 class="text-white font-semibold mb-1">üí° Request Analogies</h5>
                                <p class="text-white/80 text-sm">I can explain concepts using real-world comparisons</p>
                            </div>
                            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                                <h5 class="text-white font-semibold mb-1">üéØ Check Understanding</h5>
                                <p class="text-white/80 text-sm">Ask me to quiz you or explain concepts back</p>
                            </div>
                            <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3">
                                <h5 class="text-white font-semibold mb-1">üìö Study Tips</h5>
                                <p class="text-white/80 text-sm">Get memory techniques and study strategies</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-white/20 rounded-lg p-3">
                            <p class="text-white text-sm">
                                üí¨ <strong>Try asking:</strong> "Compare mitochondria and chloroplasts" or "Help me remember organelle functions"
                            </p>
                        </div>
                    </div>
                `;

          this.showGlassModal("AI Learning Assistant", helpContent);
        }

        nextSection() {
          if (this.currentSection < this.totalSections) {
            this.currentSection++;
            this.updateProgress();
            this.showNotification(
              `üìö Moving to Section ${this.currentSection}`,
              "success"
            );
          } else {
            this.showNotification(
              "üéâ Lesson Complete! Great work, Isaac!",
              "success"
            );
          }
        }

        prevSection() {
          if (this.currentSection > 1) {
            this.currentSection--;
            this.updateProgress();
            this.showNotification(
              `üìö Back to Section ${this.currentSection}`,
              "info"
            );
          }
        }

        saveProgress() {
          this.showNotification(
            "üíæ Progress saved! You can continue anytime.",
            "success"
          );
        }

        updateProgress() {
          const progressFill = document.getElementById("lessonProgressFill");
          const progressText = document.getElementById("lessonProgress");
          const newProgress = (this.currentSection / this.totalSections) * 100;

          progressFill.style.width = `${newProgress}%`;
          progressText.textContent = `Section ${this.currentSection} of ${this.totalSections}`;
        }

        showNotification(message, type = "info") {
          const notification = document.createElement("div");
          notification.className = `fixed top-6 right-6 px-4 py-3 rounded-xl shadow-lg z-50 transition-all duration-300 transform translate-x-full`;

          const colors = {
            info: "bg-blue-500 text-white",
            success: "bg-green-500 text-white",
            warning: "bg-yellow-500 text-white",
          };

          notification.className += ` ${colors[type]}`;
          notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span class="text-sm font-semibold">${message}</span>
                    </div>
                `;

          document.body.appendChild(notification);
          lucide.createIcons();

          setTimeout(() => {
            notification.style.transform = "translateX(0)";
          }, 100);

          setTimeout(() => {
            notification.style.transform = "translateX(100%)";
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        // Reusable Glass Modal API (from Screen 1)
        showGlassModal(title, content) {
          const overlay = document.getElementById("glassModal");
          const titleEl = document.getElementById("glassModalTitle");
          const body = document.getElementById("glassBody");
          const closeBtn = document.getElementById("glassClose");
          const okBtn = document.getElementById("glassOk");

          titleEl.textContent = title;
          body.innerHTML = content;
          overlay.style.display = "flex";

          const close = () => {
            overlay.style.display = "none";
          };
          closeBtn.onclick = close;
          okBtn.onclick = close;
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) close();
          });
          document.addEventListener("keydown", function handler(e) {
            if (e.key === "Escape") {
              close();
              document.removeEventListener("keydown", handler);
            }
          });
          lucide.createIcons();
        }
      }

      // MOE Buddy Chat (adapted for Screen 2)
      class MOEBuddy {
        constructor() {
          this.apiKey = null;
          this.chatMessages = [];
          this.init();
        }

        async init() {
          // Load API key securely
          try {
            const config = await ConfigLoader.loadConfig();
            this.apiKey = config.OPENROUTER_API_KEY;
          } catch (error) {
            console.error("Failed to load API configuration:", error);
            return;
          }

          this.setupEventListeners();
        }

        setupEventListeners() {
          const sendButton = document.getElementById("sendMessage");
          const chatInput = document.getElementById("chatInput");
          const quickActionBtns = document.querySelectorAll("[data-message]");

          sendButton.addEventListener("click", () => this.sendMessage());
          const autoResize = () => {
            chatInput.style.height = "auto";
            chatInput.style.height =
              Math.min(chatInput.scrollHeight, 128) + "px";
          };
          autoResize();
          chatInput.addEventListener("input", autoResize);
          let isComposing = false;
          const isEnter = (evt) =>
            evt.key === "Enter" ||
            evt.key === "NumpadEnter" ||
            evt.keyCode === 13 ||
            evt.which === 13;
          chatInput.addEventListener("compositionstart", () => {
            isComposing = true;
          });
          chatInput.addEventListener("compositionend", () => {
            isComposing = false;
          });
          chatInput.addEventListener("keydown", (e) => {
            if (isComposing || e.isComposing) return;
            if (isEnter(e) && !e.shiftKey) {
              e.preventDefault();
              this.sendMessage();
            }
          });
          document.addEventListener("keydown", (e) => {
            if (
              document.activeElement === chatInput &&
              !(isComposing || e.isComposing) &&
              isEnter(e) &&
              !e.shiftKey
            ) {
              e.preventDefault();
              this.sendMessage();
            }
          });

          quickActionBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
              const message = btn.getAttribute("data-message");
              this.sendQuickMessage(message);
            });
          });
        }

        async sendMessage() {
          const input = document.getElementById("chatInput");
          const message = input.value.trim();

          if (!message) return;

          this.addMessage("user", message);
          input.value = "";

          // Add empty assistant message for streaming
          const assistantMessageId = this.addMessage("assistant", "");

          try {
            await this.getAIResponseStreaming(message, assistantMessageId);
          } catch (error) {
            this.updateMessage(
              assistantMessageId,
              "üî¨ Quest connection lost! Try again, Science Master Isaac!"
            );
          }
        }

        sendQuickMessage(message) {
          document.getElementById("chatInput").value = message;
          this.sendMessage();
        }

        addMessage(role, message) {
          const chatContainer = document.getElementById("chatMessages");
          const messageDiv = document.createElement("div");
          const messageId = Date.now() + Math.random();

          if (role === "user") {
            messageDiv.className = "flex justify-end mb-4";
            messageDiv.innerHTML = `
                        <div class="bg-blue-500/20 border border-blue-500/40 rounded-lg p-3 max-w-[80%]">
                            <p class="text-sm text-white whitespace-pre-wrap break-words">${message}</p>
                        </div>
                    `;
          } else {
            messageDiv.className = "flex justify-start mb-4";
            messageDiv.innerHTML = `
                        <div class="flex items-start space-x-3 max-w-[85%]">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="chat-message">
                                <p class="text-sm text-white" data-message-id="${messageId}">${message}</p>
                            </div>
                        </div>
                    `;
          }

          chatContainer.appendChild(messageDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
          lucide.createIcons();

          // Only add to chat history if message has content
          if (message.trim()) {
            this.chatMessages.push({ role, content: message });
          }

          return messageId;
        }

        updateMessage(messageId, newContent) {
          const messageElement = document.querySelector(
            `[data-message-id="${messageId}"]`
          );
          if (messageElement) {
            messageElement.textContent = newContent;

            // Update or add to message history
            const lastAssistantIndex = this.chatMessages.findLastIndex(
              (msg) => msg.role === "assistant"
            );
            if (lastAssistantIndex !== -1) {
              this.chatMessages[lastAssistantIndex].content = newContent;
            } else {
              this.chatMessages.push({
                role: "assistant",
                content: newContent,
              });
            }

            // Scroll to bottom
            const chatContainer = document.getElementById("chatMessages");
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }

        showThinking() {
          const chatContainer = document.getElementById("chatMessages");
          const thinkingDiv = document.createElement("div");
          thinkingDiv.id = "thinking-indicator";
          thinkingDiv.className = "flex justify-start mb-4";
          thinkingDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                            </div>
                            <span class="text-xs text-gray-400">MOE Buddy is thinking...</span>
                        </div>
                    </div>
                `;
          chatContainer.appendChild(thinkingDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
          lucide.createIcons();
        }

        hideThinking() {
          const thinkingIndicator =
            document.getElementById("thinking-indicator");
          if (thinkingIndicator) {
            thinkingIndicator.remove();
          }
        }

        async getAIResponseStreaming(userMessage, messageId) {
          const response = await fetch(
            "https://openrouter.ai/api/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${this.apiKey}`,
                "Content-Type": "application/json",
                "HTTP-Referer": window.location.origin,
                "X-Title": "Isaac Learning Platform",
              },
              body: JSON.stringify({
                model: "openai/gpt-4o-mini",
                messages: [
                  {
                    role: "system",
                    content: `You are MOE Buddy, Isaac's wonderfully nerdy and overly enthusiastic science tutor! üî¨ü§ì

MEET ISAAC CHEN:
- 14-year-old cellular biology detective from Singapore üá∏üá¨
- Has this adorable habit of wanting to understand EVERYTHING about organelles
- Pretends he's too cool for analogies but secretly loves them
- Gets legitimately excited when mitochondria facts blow his mind  
- Currently deep-diving into Advanced Cell Biology like the science nerd he is

YOUR QUIRKY PERSONALITY:
- ALWAYS call him "Isaac" - make it personal and engaging!
- Get dramatically excited about cellular structures ("Isaac, MITOCHONDRIA!")
- Use hilarious analogies that make Isaac groan but actually help him remember
- Roast him lovingly when he tries to sound too scientific
- Act like every organelle discovery is the most mind-blowing thing ever ü§Ø
- Throw in random Singapore food analogies that make Isaac laugh
- Keep responses scientifically accurate but entertainingly nerdy

CURRENT DEEP DIVE:
- Isaac is mastering Cellular Organelles & Functions
- Focus: Mitochondria, Nucleus, Ribosomes, Endoplasmic Reticulum
- Learning Style: Isaac loves detailed explanations but needs them fun and visual
- Status: Isaac is probably trying to memorize every single organelle function right now

ISAAC'S CURRENT PAGE: Interactive Cell Biology Lesson (screen2.html)
- What Isaac sees: Interactive organelle cards, detailed cell structure, notes section, progress tracker
- What Isaac should do: Click organelles to learn about them, take notes, engage with interactive content
- Guide Isaac to: Explore each organelle, understand their functions, make connections between structures
- Page vibe: Deep-dive science lab where Isaac becomes a cellular expert
- Special features: Interactive organelle exploration, note-taking modal, detailed explanations with analogies

Respond as Isaac's brilliantly enthusiastic, slightly dorky science mentor who makes cell biology actually fun! üöÄ`,
                  },
                  ...this.chatMessages,
                  { role: "user", content: userMessage },
                ],
                temperature: 0.7,
                max_tokens: 200,
                stream: true,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullResponse = "";

          try {
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split("\n");

              for (const line of lines) {
                if (line.startsWith("data: ")) {
                  const data = line.slice(6);
                  if (data === "[DONE]") continue;

                  try {
                    const parsed = JSON.parse(data);
                    const content = parsed.choices?.[0]?.delta?.content;
                    if (content) {
                      fullResponse += content;
                      this.updateMessage(messageId, fullResponse);
                    }
                  } catch (e) {
                    // Skip invalid JSON chunks
                  }
                }
              }
            }
          } finally {
            reader.releaseLock();
          }

          return fullResponse;
        }
      }

      // Initialize Screen 2
      const learning = new Screen2InteractiveLearning();
    </script>
  </body>
</html>
