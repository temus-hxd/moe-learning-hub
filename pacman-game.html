<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isaac's Academy - Educational Pacman</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/light-mode.css" id="theme-css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 0;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin: 0;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .question-panel {
            background: rgba(65, 105, 225, 0.8);
            border: 3px solid #4169E1;
            border-radius: 12px;
            padding: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .answers-display {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.8rem;
            flex-shrink: 0;
        }

        .answer-choice {
            background: rgba(255, 255, 0, 0.8);
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 0.8rem;
            font-weight: 600;
            color: #000;
            font-size: 0.9rem;
            text-align: center;
        }

        .answer-choice.correct {
            background: rgba(0, 255, 0, 0.8);
            border-color: #00FF00;
        }

        .game-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 0;
            width: 100%;
            height: 100%;
        }

        #pacman {
            border: 4px solid #4169E1;
            border-radius: 12px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pacman canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .game-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .game-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 3px solid #FFD700;
            border-radius: 20px;
            padding: 3rem 4rem;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.7);
            transition: transform 0.3s ease;
            max-width: 90vw;
        }

        .game-modal.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #FFD700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .modal-message {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .modal-button {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        .modal-controls {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 2rem;
                margin: 1rem;
            }

            .modal-title {
                font-size: 2rem;
            }

            .modal-message {
                font-size: 1.1rem;
            }
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: left;
            font-size: 0.9rem;
            flex: 1;
        }

        .instructions h3 {
            color: #FFD700;
            text-align: center;
            margin-bottom: 1rem;
            margin-top: 0;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .instructions li {
            margin: 0.8rem 0;
            padding-left: 1.5rem;
            position: relative;
            line-height: 1.4;
        }

        .instructions li:before {
            content: "üéÆ";
            position: absolute;
            left: 0;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            flex-shrink: 0;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.start {
            background: linear-gradient(45deg, #10b981, #059669);
            font-size: 1rem;
            padding: 1rem;
        }

        .game-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .game-stats h4 {
            color: #FFD700;
            margin: 0 0 0.5rem 0;
            text-align: center;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 0.3rem 0;
        }

        .stat-value {
            color: #FFD700;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            .game-layout {
                grid-template-columns: 250px 1fr 250px;
                gap: 15px;
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .question-panel {
                font-size: 1rem;
                padding: 1rem;
            }
            
            .instructions {
                font-size: 0.8rem;
                padding: 1rem;
            }
        }

        @media (max-width: 900px) {
            .game-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                height: 100vh;
                overflow-y: auto;
            }
            
            .game-header {
                grid-column: 1;
            }
            
            .left-panel {
                grid-row: 2;
                flex-direction: row;
                gap: 1rem;
                overflow-x: auto;
                overflow-y: visible;
            }
            
            .question-panel {
                min-width: 300px;
                flex-shrink: 0;
            }
            
            .answers-display {
                min-width: 200px;
                flex-shrink: 0;
            }
            
            .game-center {
                grid-row: 3;
                justify-content: flex-start;
            }
            
            .right-panel {
                grid-row: 4;
                flex-direction: row;
                gap: 1rem;
            }
            
            .instructions {
                min-width: 300px;
            }
            
            .controls {
                min-width: 200px;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="game-layout">
        <!-- Header -->
        <div class="game-header">
            <h1>üéÆ EDUCATIONAL PACMAN</h1>
        </div>

        <!-- Left Panel - Questions & Answers -->
        <div class="left-panel">
            <div class="question-panel" id="questionPanel">
                <div id="currentQuestion">Press SPACE to start your Singapore History adventure!</div>
            </div>

            <div class="answers-display" id="answersDisplay" style="display: none;">
                <div class="answer-choice" id="choiceA">A: </div>
                <div class="answer-choice" id="choiceB">B: </div>
                <div class="answer-choice" id="choiceC">C: </div>
                <div class="answer-choice" id="choiceD">D: </div>
            </div>

            <div class="game-stats" id="gameStats" style="display: none;">
                <h4>Game Stats</h4>
                <div class="stat-row">
                    <span>Ghost Speed:</span>
                    <span class="stat-value" id="speedDisplay">1.0x</span>
                </div>
                <div class="stat-row">
                    <span>Current Level:</span>
                    <span class="stat-value" id="levelDisplay">1</span>
                </div>
            </div>
        </div>

        <!-- Center - Game Area -->
        <div class="game-center">
            <div id="pacman"></div>
        </div>

        <!-- Right Panel - Instructions & Controls -->
        <div class="right-panel">
            <div class="instructions">
                <h3>How to Play</h3>
                <ul>
                    <li>Use arrow keys to move Pacman around the maze</li>
                    <li>Find and eat the letter (A, B, C, D) that corresponds to the correct answer</li>
                    <li>Eating the CORRECT answer wins the game! üéâ</li>
                    <li>Eating a WRONG answer gives you power but makes ghosts faster</li>
                    <li>Avoid ghosts unless you have power from eating an answer</li>
                    <li>Press SPACE to start a new game, P to pause, S to toggle sound</li>
                </ul>
            </div>

            <div class="controls">
                <button class="btn start" onclick="simulateKeyPress(32)">üéÆ Start New Game (SPACE)</button>
                <button class="btn" onclick="simulateKeyPress(80)">‚è∏Ô∏è Pause/Resume (P)</button>
                <button class="btn" onclick="simulateKeyPress(83)">üîä Toggle Sound (S)</button>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="game-modal" id="gameModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">üéÆ Ready to Play?</div>
            <div class="modal-message" id="modalMessage">Press SPACE to start your Singapore History adventure!</div>
            <button class="modal-button" onclick="simulateKeyPress(32)">
                üöÄ START GAME (SPACE)
            </button>
            <div class="modal-controls">
                Or use keyboard: SPACE to start ‚Ä¢ P to pause ‚Ä¢ S for sound
            </div>
        </div>
    </div>

    <script>
        /*jslint browser: true, undef: true, eqeqeq: true, nomen: true, white: true */
        /*global window: false, document: false */

        var NONE        = 4,
            UP          = 3,
            LEFT        = 2,
            DOWN        = 1,
            RIGHT       = 11,
            WAITING     = 5,
            PAUSE       = 6,
            PLAYING     = 7,
            COUNTDOWN   = 8,
            EATEN_PAUSE = 9,
            DYING       = 10,
            WON         = 12,
            Pacman      = {};

        Pacman.FPS = 30;

        // Educational game variables
        var EducationalGame = {
            currentQuestion: null,
            questionBank: [
                {
                    question: "When did Singapore gain independence from Malaysia?",
                    answers: ["1963", "1965", "1967", "1969"],
                    correct: 1 // B
                },
                {
                    question: "Who was Singapore's first Prime Minister?",
                    answers: ["Lee Kuan Yew", "Goh Chok Tong", "Lee Hsien Loong", "David Marshall"],
                    correct: 0 // A
                },
                {
                    question: "What was Singapore called during the 14th century?",
                    answers: ["Temasek", "Singapura", "Lion City", "Garden City"],
                    correct: 0 // A
                },
                {
                    question: "In which year did Singapore join Malaysia?",
                    answers: ["1962", "1963", "1964", "1965"],
                    correct: 1 // B
                },
                {
                    question: "Who founded modern Singapore in 1819?",
                    answers: ["Thomas Raffles", "Frank Swettenham", "Andrew Clarke", "Harry Ord"],
                    correct: 0 // A
                },
                {
                    question: "What was the main reason for Singapore's separation from Malaysia?",
                    answers: ["Economic disputes", "Racial tensions", "Political differences", "All of the above"],
                    correct: 3 // D
                },
                {
                    question: "When did the Japanese occupation of Singapore end?",
                    answers: ["1944", "1945", "1946", "1947"],
                    correct: 1 // B
                },
                {
                    question: "What was Operation Coldstore?",
                    answers: ["Economic plan", "Security operation", "Education reform", "Housing project"],
                    correct: 1 // B
                }
            ],
            ghostSpeedMultiplier: 1.0,
            
            loadRandomQuestion: function() {
                this.currentQuestion = this.questionBank[Math.floor(Math.random() * this.questionBank.length)];
                this.displayQuestion();
            },
            
            displayQuestion: function() {
                if (!this.currentQuestion) return;
                
                document.getElementById('currentQuestion').textContent = this.currentQuestion.question;
                document.getElementById('answersDisplay').style.display = 'grid';
                
                var choices = ['choiceA', 'choiceB', 'choiceC', 'choiceD'];
                choices.forEach(function(id, index) {
                    var element = document.getElementById(id);
                    element.textContent = String.fromCharCode(65 + index) + ': ' + EducationalGame.currentQuestion.answers[index];
                    element.classList.remove('correct');
                    if (index === EducationalGame.currentQuestion.correct) {
                        element.classList.add('correct');
                    }
                });
            }
        };

        Pacman.Ghost = function (game, map, colour) {

            var position  = null,
                direction = null,
                eatable   = null,
                eaten     = null,
                due       = null;
            
            function getNewCoord(dir, current) { 
                
                var speed  = isVunerable() ? 1 : isHidden() ? 4 : 2 * EducationalGame.ghostSpeedMultiplier,
                    xSpeed = (dir === LEFT && -speed || dir === RIGHT && speed || 0),
                    ySpeed = (dir === DOWN && speed || dir === UP && -speed || 0);
            
                return {
                    "x": addBounded(current.x, xSpeed),
                    "y": addBounded(current.y, ySpeed)
                };
            };

            function addBounded(x1, x2) { 
                var rem    = x1 % 10, 
                    result = rem + x2;
                if (rem !== 0 && result > 10) {
                    return x1 + (10 - rem);
                } else if(rem > 0 && result < 0) { 
                    return x1 - rem;
                }
                return x1 + x2;
            };
            
            function isVunerable() { 
                return eatable !== null;
            };
            
            function isDangerous() {
                return eaten === null;
            };

            function isHidden() { 
                return eatable === null && eaten !== null;
            };
            
            function getRandomDirection() {
                var moves = (direction === LEFT || direction === RIGHT) 
                    ? [UP, DOWN] : [LEFT, RIGHT];
                return moves[Math.floor(Math.random() * 2)];
            };
            
            function reset() {
                eaten = null;
                eatable = null;
                position = {"x": 90, "y": 80};
                direction = getRandomDirection();
                due = getRandomDirection();
            };
            
            function onWholeSquare(x) {
                return x % 10 === 0;
            };
            
            function oppositeDirection(dir) { 
                return dir === LEFT && RIGHT ||
                    dir === RIGHT && LEFT ||
                    dir === UP && DOWN || UP;
            };

            function makeEatable() {
                direction = oppositeDirection(direction);
                eatable = game.getTick();
            };

            function eat() { 
                eatable = null;
                eaten = game.getTick();
            };

            function pointToCoord(x) {
                return Math.round(x / 10);
            };

            function nextSquare(x, dir) {
                var rem = x % 10;
                if (rem === 0) { 
                    return x; 
                } else if (dir === RIGHT || dir === DOWN) { 
                    return x + (10 - rem);
                } else {
                    return x - rem;
                }
            };

            function onGridSquare(pos) {
                return onWholeSquare(pos.y) && onWholeSquare(pos.x);
            };

            function secondsAgo(tick) { 
                return (game.getTick() - tick) / Pacman.FPS;
            };

            function getColour() { 
                if (eatable) { 
                    if (secondsAgo(eatable) > 5) { 
                        return game.getTick() % 20 > 10 ? "#FFFFFF" : "#0000BB";
                    } else { 
                        return "#0000BB";
                    }
                } else if(eaten) { 
                    return "#222";
                } 
                return colour;
            };

            function draw(ctx) {
          
                var s    = map.blockSize, 
                    top  = (position.y/10) * s,
                    left = (position.x/10) * s;
            
                if (eatable && secondsAgo(eatable) > 8) {
                    eatable = null;
                }
                
                if (eaten && secondsAgo(eaten) > 3) { 
                    eaten = null;
                }
                
                var tl = left + s;
                var base = top + s - 3;
                var inc = s / 10;

                var high = game.getTick() % 10 > 5 ? 3  : -3;
                var low  = game.getTick() % 10 > 5 ? -3 : 3;

                ctx.fillStyle = getColour();
                ctx.beginPath();

                ctx.moveTo(left, base);

                ctx.quadraticCurveTo(left, top, left + (s/2),  top);
                ctx.quadraticCurveTo(left + s, top, left+s,  base);
                
                // Wavy things at the bottom
                ctx.quadraticCurveTo(tl-(inc*1), base+high, tl - (inc * 2),  base);
                ctx.quadraticCurveTo(tl-(inc*3), base+low, tl - (inc * 4),  base);
                ctx.quadraticCurveTo(tl-(inc*5), base+high, tl - (inc * 6),  base);
                ctx.quadraticCurveTo(tl-(inc*7), base+low, tl - (inc * 8),  base); 
                ctx.quadraticCurveTo(tl-(inc*9), base+high, tl - (inc * 10), base); 

                ctx.closePath();
                ctx.fill();

                ctx.beginPath();
                ctx.fillStyle = "#FFF";
                ctx.arc(left + 6,top + 6, s / 6, 0, 300, false);
                ctx.arc((left + s) - 6,top + 6, s / 6, 0, 300, false);
                ctx.closePath();
                ctx.fill();

                var f = s / 12;
                var off = {};
                off[RIGHT] = [f, 0];
                off[LEFT]  = [-f, 0];
                off[UP]    = [0, -f];
                off[DOWN]  = [0, f];

                ctx.beginPath();
                ctx.fillStyle = "#000";
                ctx.arc(left+6+off[direction][0], top+6+off[direction][1], 
                        s / 15, 0, 300, false);
                ctx.arc((left+s)-6+off[direction][0], top+6+off[direction][1], 
                        s / 15, 0, 300, false);
                ctx.closePath();
                ctx.fill();

            };

            function pane(pos) {

                if (pos.y === 100 && pos.x >= 190 && direction === RIGHT) {
                    return {"y": 100, "x": -10};
                }
                
                if (pos.y === 100 && pos.x <= -10 && direction === LEFT) {
                    return position = {"y": 100, "x": 190};
                }

                return false;
            };
            
            function move(ctx) {
                
                var oldPos = position,
                    onGrid = onGridSquare(position),
                    npos   = null;
                
                if (due !== direction) {
                    
                    npos = getNewCoord(due, position);
                    
                    if (onGrid &&
                        map.isFloorSpace({
                            "y":pointToCoord(nextSquare(npos.y, due)),
                            "x":pointToCoord(nextSquare(npos.x, due))})) {
                        direction = due;
                    } else {
                        npos = null;
                    }
                }
                
                if (npos === null) {
                    npos = getNewCoord(direction, position);
                }
                
                if (onGrid &&
                    map.isWallSpace({
                        "y" : pointToCoord(nextSquare(npos.y, direction)),
                        "x" : pointToCoord(nextSquare(npos.x, direction))
                    })) {
                    
                    due = getRandomDirection();            
                    return move(ctx);
                }

                position = npos;        
                
                var tmp = pane(position);
                if (tmp) { 
                    position = tmp;
                }
                
                due = getRandomDirection();
                
                return {
                    "new" : position,
                    "old" : oldPos
                };
            };
            
            return {
                "eat"         : eat,
                "isVunerable" : isVunerable,
                "isDangerous" : isDangerous,
                "makeEatable" : makeEatable,
                "reset"       : reset,
                "move"        : move,
                "draw"        : draw
            };
        };

        Pacman.User = function (game, map) {
            
            var position  = null,
                direction = null,
                eaten     = null,
                due       = null, 
                lives     = null,
                score     = 5,
                keyMap    = {};
            
            keyMap[37]  = LEFT;  // Arrow Left
            keyMap[38]  = UP;    // Arrow Up  
            keyMap[39]  = RIGHT; // Arrow Right
            keyMap[40]  = DOWN;  // Arrow Down

            function addScore(nScore) { 
                score += nScore;
                if (score >= 10000 && score - nScore < 10000) { 
                    lives += 1;
                }
            };

            function theScore() { 
                return score;
            };

            function loseLife() { 
                lives -= 1;
            };

            function getLives() {
                return lives;
            };

            function initUser() {
                score = 0;
                lives = 3;
                newLevel();
            }
            
            function newLevel() {
                resetPosition();
                eaten = 0;
            };
            
            function resetPosition() {
                position = {"x": 90, "y": 120};
                direction = LEFT;
                due = LEFT;
            };
            
            function reset() {
                initUser();
                resetPosition();
            };        
            
            function keyDown(e) {
                if (typeof keyMap[e.keyCode] !== "undefined") { 
                    due = keyMap[e.keyCode];
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                return true;
            };

            function getNewCoord(dir, current) {   
                return {
                    "x": current.x + (dir === LEFT && -2 || dir === RIGHT && 2 || 0),
                    "y": current.y + (dir === DOWN && 2 || dir === UP    && -2 || 0)
                };
            };

            function onWholeSquare(x) {
                return x % 10 === 0;
            };

            function pointToCoord(x) {
                return Math.round(x/10);
            };
            
            function nextSquare(x, dir) {
                var rem = x % 10;
                if (rem === 0) { 
                    return x; 
                } else if (dir === RIGHT || dir === DOWN) { 
                    return x + (10 - rem);
                } else {
                    return x - rem;
                }
            };

            function next(pos, dir) {
                return {
                    "y" : pointToCoord(nextSquare(pos.y, dir)),
                    "x" : pointToCoord(nextSquare(pos.x, dir)),
                };                               
            };

            function onGridSquare(pos) {
                return onWholeSquare(pos.y) && onWholeSquare(pos.x);
            };

            function isOnSamePlane(due, dir) { 
                return ((due === LEFT || due === RIGHT) && 
                        (dir === LEFT || dir === RIGHT)) || 
                    ((due === UP || due === DOWN) && 
                     (dir === UP || dir === DOWN));
            };

            function move(ctx) {
                
                var npos        = null, 
                    nextWhole   = null, 
                    oldPosition = position,
                    block       = null;
                
                if (due !== direction) {
                    npos = getNewCoord(due, position);
                    
                    if (isOnSamePlane(due, direction) || 
                        (onGridSquare(position) && 
                         map.isFloorSpace(next(npos, due)))) {
                        direction = due;
                    } else {
                        npos = null;
                    }
                }

                if (npos === null) {
                    npos = getNewCoord(direction, position);
                }
                
                if (onGridSquare(position) && map.isWallSpace(next(npos, direction))) {
                    direction = NONE;
                }

                if (direction === NONE) {
                    return {"new" : position, "old" : position};
                }
                
                if (npos.y === 100 && npos.x >= 190 && direction === RIGHT) {
                    npos = {"y": 100, "x": -10};
                }
                
                if (npos.y === 100 && npos.x <= -12 && direction === LEFT) {
                    npos = {"y": 100, "x": 190};
                }
                
                position = npos;        
                nextWhole = next(position, direction);
                
                block = map.block(nextWhole);        
                
                if ((isMidSquare(position.y) || isMidSquare(position.x)) &&
                    block === Pacman.BISCUIT || block === Pacman.PILL) {
                    
                    map.setBlock(nextWhole, Pacman.EMPTY);           
                    addScore((block === Pacman.BISCUIT) ? 10 : 50);
                    eaten += 1;
                    
                    if (eaten === 182) {
                        game.completedLevel();
                    }
                    
                    if (block === Pacman.PILL) { 
                        game.eatenPill();
                    }
                } else if ((isMidSquare(position.y) || isMidSquare(position.x)) &&
                          (block === Pacman.PILL_A || block === Pacman.PILL_B || 
                           block === Pacman.PILL_C || block === Pacman.PILL_D)) {
                    
                    // Educational: Answer eaten
                    map.setBlock(nextWhole, Pacman.EMPTY);
                    var answerIndex = block - Pacman.PILL_A; // 0=A, 1=B, 2=C, 3=D
                    
                    if (answerIndex === EducationalGame.currentQuestion.correct) {
                        // Correct answer - WIN!
                        game.wonGame();
                    } else {
                        // Wrong answer - power up but increase ghost speed
                        EducationalGame.ghostSpeedMultiplier += 0.3;
                        game.eatenPill();
                    }
                }   
                        
                return {
                    "new" : position,
                    "old" : oldPosition
                };
            };

            function isMidSquare(x) { 
                var rem = x % 10;
                return rem > 3 || rem < 7;
            };

            function calcAngle(dir, pos) { 
                if (dir == RIGHT && (pos.x % 10 < 5)) {
                    return {"start":0.25, "end":1.75, "direction": false};
                } else if (dir === DOWN && (pos.y % 10 < 5)) { 
                    return {"start":0.75, "end":2.25, "direction": false};
                } else if (dir === UP && (pos.y % 10 < 5)) { 
                    return {"start":1.25, "end":1.75, "direction": true};
                } else if (dir === LEFT && (pos.x % 10 < 5)) {             
                    return {"start":0.75, "end":1.25, "direction": true};
                }
                return {"start":0, "end":2, "direction": false};
            };

            function drawDead(ctx, amount) { 

                var size = map.blockSize, 
                    half = size / 2;

                if (amount >= 1) { 
                    return;
                }

                ctx.fillStyle = "#FFFF00";
                ctx.beginPath();        
                ctx.moveTo(((position.x/10) * size) + half, 
                           ((position.y/10) * size) + half);
                
                ctx.arc(((position.x/10) * size) + half, 
                        ((position.y/10) * size) + half,
                        half, 0, Math.PI * 2 * amount, true); 
                
                ctx.fill();    
            };

            function draw(ctx) { 

                var s     = map.blockSize, 
                    angle = calcAngle(direction, position);

                ctx.fillStyle = "#FFFF00";

                ctx.beginPath();        

                ctx.moveTo(((position.x/10) * s) + s / 2,
                           ((position.y/10) * s) + s / 2);
                
                ctx.arc(((position.x/10) * s) + s / 2,
                        ((position.y/10) * s) + s / 2,
                        s / 2, Math.PI * angle.start, 
                        Math.PI * angle.end, angle.direction); 
                
                ctx.fill();    
            };
            
            initUser();

            return {
                "draw"          : draw,
                "drawDead"      : drawDead,
                "loseLife"      : loseLife,
                "getLives"      : getLives,
                "score"         : score,
                "addScore"      : addScore,
                "theScore"      : theScore,
                "keyDown"       : keyDown,
                "move"          : move,
                "newLevel"      : newLevel,
                "reset"         : reset,
                "resetPosition" : resetPosition
            };
        };

        Pacman.Map = function (size) {
            
            var height    = null, 
                width     = null, 
                blockSize = size,
                pillSize  = 0,
                map       = null;
            
            function withinBounds(y, x) {
                return y >= 0 && y < height && x >= 0 && x < width;
            }
            
            function isWall(pos) {
                return withinBounds(pos.y, pos.x) && map[pos.y][pos.x] === Pacman.WALL;
            }
            
            function isFloorSpace(pos) {
                if (!withinBounds(pos.y, pos.x)) {
                    return false;
                }
                var peice = map[pos.y][pos.x];
                return peice === Pacman.EMPTY || 
                    peice === Pacman.BISCUIT ||
                    peice === Pacman.PILL ||
                    peice === Pacman.PILL_A ||
                    peice === Pacman.PILL_B ||
                    peice === Pacman.PILL_C ||
                    peice === Pacman.PILL_D;
            }
            
            function drawWall(ctx) {

                var i, j, p, line;
                
                ctx.strokeStyle = "#0000FF";
                ctx.lineWidth   = 5;
                ctx.lineCap     = "round";
                
                for (i = 0; i < Pacman.WALLS.length; i += 1) {
                    line = Pacman.WALLS[i];
                    ctx.beginPath();

                    for (j = 0; j < line.length; j += 1) {

                        p = line[j];
                        
                        if (p.move) {
                            ctx.moveTo(p.move[0] * blockSize, p.move[1] * blockSize);
                        } else if (p.line) {
                            ctx.lineTo(p.line[0] * blockSize, p.line[1] * blockSize);
                        } else if (p.curve) {
                            ctx.quadraticCurveTo(p.curve[0] * blockSize, 
                                                 p.curve[1] * blockSize,
                                                 p.curve[2] * blockSize, 
                                                 p.curve[3] * blockSize);   
                        }
                    }
                    ctx.stroke();
                }
            }
            
            function reset() {       
                map    = Pacman.MAP.clone();
                height = map.length;
                width  = map[0].length;
                
                // Replace the 4 power pills with answer letters A, B, C, D
                var pillPositions = [];
                for (var i = 0; i < height; i++) {
                    for (var j = 0; j < width; j++) {
                        if (map[i][j] === Pacman.PILL) {
                            pillPositions.push({y: i, x: j});
                        }
                    }
                }
                
                // Set the 4 power pill positions to A, B, C, D
                if (pillPositions.length >= 4) {
                    map[pillPositions[0].y][pillPositions[0].x] = Pacman.PILL_A;
                    map[pillPositions[1].y][pillPositions[1].x] = Pacman.PILL_B;
                    map[pillPositions[2].y][pillPositions[2].x] = Pacman.PILL_C;
                    map[pillPositions[3].y][pillPositions[3].x] = Pacman.PILL_D;
                }
            };

            function block(pos) {
                return map[pos.y][pos.x];
            };
            
            function setBlock(pos, type) {
                map[pos.y][pos.x] = type;
            };

            function drawPills(ctx) { 

                if (++pillSize > 30) {
                    pillSize = 0;
                }
                
                for (i = 0; i < height; i += 1) {
                    for (j = 0; j < width; j += 1) {
                        var blockType = map[i][j];
                        
                        if (blockType === Pacman.PILL) {
                            ctx.beginPath();

                            ctx.fillStyle = "#000";
                            ctx.fillRect((j * blockSize), (i * blockSize), 
                                         blockSize, blockSize);

                            ctx.fillStyle = "#FFF";
                            ctx.arc((j * blockSize) + blockSize / 2,
                                    (i * blockSize) + blockSize / 2,
                                    Math.abs(5 - (pillSize/3)), 
                                    0, 
                                    Math.PI * 2, false); 
                            ctx.fill();
                            ctx.closePath();
                        } else if (blockType >= Pacman.PILL_A && blockType <= Pacman.PILL_D) {
                            // Draw answer letter pills - STATIC SIZE (no animation)
                            ctx.beginPath();

                            ctx.fillStyle = "#000";
                            ctx.fillRect((j * blockSize), (i * blockSize), 
                                         blockSize, blockSize);

                            var letter = String.fromCharCode(65 + (blockType - Pacman.PILL_A)); // A, B, C, D
                            var isCorrect = (blockType - Pacman.PILL_A) === EducationalGame.currentQuestion.correct;
                            
                            // Static large pellet - no animation
                            ctx.fillStyle = isCorrect ? "#00FF00" : "#FFFF00";
                            ctx.arc((j * blockSize) + blockSize / 2,
                                    (i * blockSize) + blockSize / 2,
                                    10, // Fixed large size
                                    0, 
                                    Math.PI * 2, false); 
                            ctx.fill();
                            
                            // Draw letter - larger and bolder
                            ctx.fillStyle = "#000";
                            ctx.font = "bold " + (blockSize * 0.7) + "px Arial";
                            ctx.textAlign = "center";
                            ctx.textBaseline = "middle";
                            ctx.fillText(letter, 
                                        (j * blockSize) + blockSize / 2,
                                        (i * blockSize) + blockSize / 2 + 2);
                            
                            ctx.closePath();
                        }
                    }
                }
            };
            
            function draw(ctx) {
                
                var i, j, size = blockSize;

                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, width * size, height * size);

                drawWall(ctx);
                
                for (i = 0; i < height; i += 1) {
                    for (j = 0; j < width; j += 1) {
                        drawBlock(i, j, ctx);
                    }
                }
            };
            
            function drawBlock(y, x, ctx) {

                var layout = map[y][x];

                if (layout === Pacman.PILL || 
                   (layout >= Pacman.PILL_A && layout <= Pacman.PILL_D)) {
                    return;
                }

                ctx.beginPath();
                
                if (layout === Pacman.EMPTY || layout === Pacman.BLOCK || 
                    layout === Pacman.BISCUIT) {
                    
                    ctx.fillStyle = "#000";
                    ctx.fillRect((x * blockSize), (y * blockSize), 
                                 blockSize, blockSize);

                    if (layout === Pacman.BISCUIT) {
                        ctx.fillStyle = "#FFF";
                        ctx.fillRect((x * blockSize) + (blockSize / 2.5), 
                                     (y * blockSize) + (blockSize / 2.5), 
                                     blockSize / 6, blockSize / 6);
                    }
                }
                ctx.closePath();     
            };

            function redrawBlock(pos) {
                drawBlock(Math.floor(pos.y/10), Math.floor(pos.x/10), ctx);
                drawBlock(Math.ceil(pos.y/10), Math.ceil(pos.x/10), ctx);
            }

            reset();
            
            return {
                "draw"         : draw,
                "drawBlock"    : drawBlock,
                "drawPills"    : drawPills,
                "redrawBlock"  : redrawBlock,
                "block"        : block,
                "setBlock"     : setBlock,
                "reset"        : reset,
                "isWallSpace"  : isWall,
                "isFloorSpace" : isFloorSpace,
                "height"       : height,
                "width"        : width,
                "blockSize"    : blockSize
            };
        };

        Pacman.Audio = function(game) {
            
            var files          = [], 
                endEvents      = [],
                progressEvents = [],
                playing        = [];
            
            function load(name, path, cb) { 

                var f = files[name] = document.createElement("audio");

                progressEvents[name] = function(event) { progress(event, name, cb); };
                
                f.addEventListener("canplaythrough", progressEvents[name], true);
                f.setAttribute("preload", "true");
                f.setAttribute("autobuffer", "true");
                f.setAttribute("src", path);
                f.pause();        
            };

            function progress(event, name, callback) { 
                if (callback && typeof callback === "function") {
                    callback();
                    if (files[name]) {
                        files[name].removeEventListener("canplaythrough", 
                                                        progressEvents[name], true);
                    }
                }
            };

            function disableSound() {
                for (var i = 0; i < playing.length; i++) {
                    if (files[playing[i]]) {
                        files[playing[i]].pause();
                        files[playing[i]].currentTime = 0;
                    }
                }
                playing = [];
            };

            function ended(name) { 

                var i, tmp = [], found = false;

                if (files[name]) {
                    files[name].removeEventListener("ended", endEvents[name], true);
                }

                for (i = 0; i < playing.length; i++) {
                    if (!found && playing[i] === name) { 
                        found = true;
                    } else { 
                        tmp.push(playing[i]);
                    }
                }
                playing = tmp;
            };

            function play(name) { 
                if (!game.soundDisabled() && files[name]) {
                    endEvents[name] = function() { ended(name); };
                    playing.push(name);
                    files[name].addEventListener("ended", endEvents[name], true);
                    files[name].play();
                }
            };

            function pause() { 
                for (var i = 0; i < playing.length; i++) {
                    if (files[playing[i]]) {
                        files[playing[i]].pause();
                    }
                }
            };
            
            function resume() { 
                for (var i = 0; i < playing.length; i++) {
                    if (files[playing[i]]) {
                        files[playing[i]].play();
                    }
                }        
            };
            
            return {
                "disableSound" : disableSound,
                "load"         : load,
                "play"         : play,
                "pause"        : pause,
                "resume"       : resume
            };
        };

        var PACMAN = (function () {

            var state        = WAITING,
                ghosts       = [],
                ghostSpecs   = ["#00FFDE", "#FF0000", "#FFB8DE", "#FFB847"],
                eatenCount   = 0,
                level        = 0,
                tick         = 0,
                ghostPos, userPos, 
                stateChanged = true,
                timerStart   = null,
                lastTime     = 0,
                ctx          = null,
                timer        = null,
                map          = null,
                user         = null,
                stored       = null;

            function getTick() { 
                return tick;
            };

            function drawScore(text, position) {
                ctx.fillStyle = "#FFFFFF";
                ctx.font      = "12px Arial";
                ctx.fillText(text, 
                             (position["new"]["x"] / 10) * map.blockSize, 
                             ((position["new"]["y"] + 5) / 10) * map.blockSize);
            }
            
            function dialog(text) {
                // Legacy function - now handled by modal
                console.log("Dialog:", text);
            }

            function showModal(title, message, type) {
                var modal = document.getElementById('gameModal');
                var modalTitle = document.getElementById('modalTitle');
                var modalMessage = document.getElementById('modalMessage');
                
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                
                modal.classList.add('show');
            }

            function hideModal() {
                var modal = document.getElementById('gameModal');
                modal.classList.remove('show');
            }

            function soundDisabled() {
                return localStorage["soundDisabled"] === "true";
            };
            
            function startLevel() {        
                user.resetPosition();
                for (var i = 0; i < ghosts.length; i += 1) { 
                    ghosts[i].reset();
                }
                audio.play("start");
                timerStart = tick;
                setState(COUNTDOWN);
            }    

            function startNewGame() {
                setState(WAITING);
                level = 1;
                EducationalGame.ghostSpeedMultiplier = 1.0;
                EducationalGame.loadRandomQuestion();
                user.reset();
                map.reset();
                map.draw(ctx);
                hideModal();
                startLevel();
            }

            function wonGame() {
                setState(WON);
                showModal("üéâ CORRECT!", "You got the right answer! Press SPACE for a new question.", "win");
            }

            function keyDown(e) {
                if (e.keyCode === 32) { // SPACE key
                    startNewGame();
                } else if (e.keyCode === 83) { // S key
                    audio.disableSound();
                    localStorage["soundDisabled"] = !soundDisabled();
                } else if (e.keyCode === 80 && state === PAUSE) { // P key
                    audio.resume();
                    map.draw(ctx);
                    setState(stored);
                    hideModal();
                } else if (e.keyCode === 80) { // P key
                    stored = state;
                    setState(PAUSE);
                    audio.pause();
                    map.draw(ctx);
                    showModal("‚è∏Ô∏è Paused", "Game paused. Press P to continue playing.", "pause");
                } else if (state !== PAUSE && state !== WON) {   
                    return user.keyDown(e);
                }
                return true;
            }    

            function loseLife() {        
                setState(WAITING);
                user.loseLife();
                if (user.getLives() > 0) {
                    startLevel();
                } else {
                    showModal("üíÄ Game Over", "No lives left! Press SPACE to try again.", "gameover");
                }
            }

            function setState(nState) { 
                state = nState;
                stateChanged = true;
            };
            
            function collided(user, ghost) {
                return (Math.sqrt(Math.pow(ghost.x - user.x, 2) + 
                                  Math.pow(ghost.y - user.y, 2))) < 10;
            };

            function drawFooter() {
                
                var topLeft  = (map.height * map.blockSize),
                    textBase = topLeft + 17;
                
                ctx.fillStyle = "#000000";
                ctx.fillRect(0, topLeft, (map.width * map.blockSize), 30);
                
                ctx.fillStyle = "#FFFF00";

                for (var i = 0, len = user.getLives(); i < len; i++) {
                    ctx.fillStyle = "#FFFF00";
                    ctx.beginPath();
                    ctx.moveTo(150 + (25 * i) + map.blockSize / 2,
                               (topLeft+1) + map.blockSize / 2);
                    
                    ctx.arc(150 + (25 * i) + map.blockSize / 2,
                            (topLeft+1) + map.blockSize / 2,
                            map.blockSize / 2, Math.PI * 0.25, Math.PI * 1.75, false);
                    ctx.fill();
                }

                ctx.fillStyle = !soundDisabled() ? "#00FF00" : "#FF0000";
                ctx.font = "bold 16px sans-serif";
                ctx.fillText("S", 10, textBase);

                ctx.fillStyle = "#FFFF00";
                ctx.font      = "14px Arial";
                ctx.fillText("Score: " + user.theScore(), 30, textBase);
                ctx.fillText("Level: " + level, 200, textBase);
                ctx.fillText("Speed: " + EducationalGame.ghostSpeedMultiplier.toFixed(1) + "x", 280, textBase);
            }

            function redrawBlock(pos) {
                map.drawBlock(Math.floor(pos.y/10), Math.floor(pos.x/10), ctx);
                map.drawBlock(Math.ceil(pos.y/10), Math.ceil(pos.x/10), ctx);
            }

            function mainDraw() { 

                var diff, u, i, len, nScore;
                
                ghostPos = [];

                for (i = 0, len = ghosts.length; i < len; i += 1) {
                    ghostPos.push(ghosts[i].move(ctx));
                }
                u = user.move(ctx);
                
                for (i = 0, len = ghosts.length; i < len; i += 1) {
                    redrawBlock(ghostPos[i].old);
                }
                redrawBlock(u.old);
                
                for (i = 0, len = ghosts.length; i < len; i += 1) {
                    ghosts[i].draw(ctx);
                }                     
                user.draw(ctx);
                
                userPos = u["new"];
                
                for (i = 0, len = ghosts.length; i < len; i += 1) {
                    if (collided(userPos, ghostPos[i]["new"])) {
                        if (ghosts[i].isVunerable()) { 
                            audio.play("eatghost");
                            ghosts[i].eat();
                            eatenCount += 1;
                            nScore = eatenCount * 50;
                            drawScore(nScore, ghostPos[i]);
                            user.addScore(nScore);                    
                            setState(EATEN_PAUSE);
                            timerStart = tick;
                        } else if (ghosts[i].isDangerous()) {
                            audio.play("die");
                            setState(DYING);
                            timerStart = tick;
                        }
                    }
                }                             
            };

            function mainLoop() {

                var diff;

                if (state !== PAUSE) { 
                    ++tick;
                }

                map.drawPills(ctx);

                if (state === PLAYING) {
                    mainDraw();
                } else if (state === WAITING && stateChanged) {            
                    stateChanged = false;
                    map.draw(ctx);
                    // Modal handles the waiting state display            
                } else if (state === WON && stateChanged) {
                    stateChanged = false;
                    // Keep showing win message
                } else if (state === EATEN_PAUSE && 
                           (tick - timerStart) > (Pacman.FPS / 3)) {
                    map.draw(ctx);
                    setState(PLAYING);
                } else if (state === DYING) {
                    if (tick - timerStart > (Pacman.FPS * 2)) { 
                        loseLife();
                    } else { 
                        redrawBlock(userPos);
                        for (i = 0, len = ghosts.length; i < len; i += 1) {
                            redrawBlock(ghostPos[i].old);
                            ghostPos.push(ghosts[i].draw(ctx));
                        }                                   
                        user.drawDead(ctx, (tick - timerStart) / (Pacman.FPS * 2));
                    }
                } else if (state === COUNTDOWN) {
                    
                    diff = 2 + Math.floor((timerStart - tick) / Pacman.FPS);
                    
                    if (diff === 0) {
                        map.draw(ctx);
                        setState(PLAYING);
                    } else {
                        if (diff !== lastTime) { 
                            lastTime = diff;
                            map.draw(ctx);
                            dialog("Starting in: " + diff);
                        }
                    }
                } 

                drawFooter();
            }

            function eatenPill() {
                audio.play("eatpill");
                timerStart = tick;
                eatenCount = 0;
                for (i = 0; i < ghosts.length; i += 1) {
                    ghosts[i].makeEatable(ctx);
                }        
            };
            
            function completedLevel() {
                setState(WAITING);
                level += 1;
                map.reset();
                user.newLevel();
                startLevel();
            };

            function keyPress(e) { 
                if (state !== WAITING && state !== PAUSE) { 
                    e.preventDefault();
                    e.stopPropagation();
                }
            };
            
            function init(wrapper, root) {
                
                var i, len, ghost,
                    availableWidth = wrapper.parentElement.offsetWidth - 40, // Account for padding
                    availableHeight = window.innerHeight - 200, // Account for header and padding
                    blockSize = Math.min(availableWidth / 19, availableHeight / 22),
                    canvas    = document.createElement("canvas");
                
                // Ensure minimum size
                blockSize = Math.max(blockSize, 15);
                
                canvas.setAttribute("width", (blockSize * 19) + "px");
                canvas.setAttribute("height", (blockSize * 22) + 30 + "px");

                wrapper.appendChild(canvas);

                ctx  = canvas.getContext('2d');

                audio = new Pacman.Audio({"soundDisabled":soundDisabled});
                map   = new Pacman.Map(blockSize);
                user  = new Pacman.User({ 
                    "completedLevel" : completedLevel, 
                    "eatenPill"      : eatenPill,
                    "wonGame"        : wonGame,
                    "getTick"        : getTick
                }, map);

                for (i = 0, len = ghostSpecs.length; i < len; i += 1) {
                    ghost = new Pacman.Ghost({"getTick":getTick}, map, ghostSpecs[i]);
                    ghosts.push(ghost);
                }
                
                map.draw(ctx);
                dialog("Loading ...");

                var extension = 'mp3'; // Default to mp3
                if (typeof Audio !== 'undefined') {
                    var testAudio = new Audio();
                    if (testAudio.canPlayType && testAudio.canPlayType('audio/ogg') !== '') {
                        extension = 'ogg';
                    }
                }

                var audio_files = [
                    ["start", "https://raw.githubusercontent.com/daleharvey/pacman/master/audio/opening_song." + extension],
                    ["die", "https://raw.githubusercontent.com/daleharvey/pacman/master/audio/die." + extension],
                    ["eatghost", "https://raw.githubusercontent.com/daleharvey/pacman/master/audio/eatghost." + extension],
                    ["eatpill", "https://raw.githubusercontent.com/daleharvey/pacman/master/audio/eatpill." + extension],
                    ["eating", "https://raw.githubusercontent.com/daleharvey/pacman/master/audio/eating.short." + extension],
                    ["eating2", "https://raw.githubusercontent.com/daleharvey/pacman/master/audio/eating.short." + extension]
                ];

                loadAudioFiles(audio_files, function() { loaded(); });
            };

            function loadAudioFiles(arr, callback) { 
                
                if (arr.length === 0) { 
                    callback();
                } else { 
                    var x = arr.pop();
                    audio.load(x[0], x[1], function() { loadAudioFiles(arr, callback); });
                }
            };
                
            function loaded() {

                EducationalGame.loadRandomQuestion();
                showModal("üéÆ Ready to Play?", "Press SPACE to start your Singapore History adventure!", "start");
                
                document.addEventListener("keydown", keyDown, true);
                document.addEventListener("keypress", keyPress, true); 
                
                timer = window.setInterval(mainLoop, 1000 / Pacman.FPS);
            };
            
            return {
                "init" : init
            };
            
        }());

        // Game constants
        Pacman.WALL    = 0;
        Pacman.BISCUIT = 1;
        Pacman.EMPTY   = 2;
        Pacman.BLOCK   = 3;
        Pacman.PILL    = 4;
        Pacman.PILL_A  = 5;  // Answer A
        Pacman.PILL_B  = 6;  // Answer B
        Pacman.PILL_C  = 7;  // Answer C
        Pacman.PILL_D  = 8;  // Answer D

        // Original Pacman map
        Pacman.MAP = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 4, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 4, 0],
            [0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0],
            [0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0],
            [0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0],
            [2, 2, 2, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 2, 2, 2],
            [0, 0, 0, 0, 1, 0, 1, 0, 0, 3, 0, 0, 1, 0, 1, 0, 0, 0, 0],
            [2, 2, 2, 2, 1, 1, 1, 0, 3, 3, 3, 0, 1, 1, 1, 2, 2, 2, 2],
            [0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0],
            [2, 2, 2, 0, 1, 0, 1, 1, 1, 2, 1, 1, 1, 0, 1, 0, 2, 2, 2],
            [0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0],
            [0, 4, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 4, 0],
            [0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0],
            [0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0],
            [0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];

        // Wall definitions (same as original)
        Pacman.WALLS = [
            
            [{"move": [0, 9.5]}, {"line": [3, 9.5]},
             {"curve": [3.5, 9.5, 3.5, 9]}, {"line": [3.5, 8]},
             {"curve": [3.5, 7.5, 3, 7.5]}, {"line": [1, 7.5]},
             {"curve": [0.5, 7.5, 0.5, 7]}, {"line": [0.5, 1]},
             {"curve": [0.5, 0.5, 1, 0.5]}, {"line": [9, 0.5]},
             {"curve": [9.5, 0.5, 9.5, 1]}, {"line": [9.5, 3.5]}],

            [{"move": [9.5, 1]},
             {"curve": [9.5, 0.5, 10, 0.5]}, {"line": [18, 0.5]},
             {"curve": [18.5, 0.5, 18.5, 1]}, {"line": [18.5, 7]},
             {"curve": [18.5, 7.5, 18, 7.5]}, {"line": [16, 7.5]},
             {"curve": [15.5, 7.5, 15.5, 8]}, {"line": [15.5, 9]},
             {"curve": [15.5, 9.5, 16, 9.5]}, {"line": [19, 9.5]}],

            [{"move": [2.5, 5.5]}, {"line": [3.5, 5.5]}],

            [{"move": [3, 2.5]},
             {"curve": [3.5, 2.5, 3.5, 3]},
             {"curve": [3.5, 3.5, 3, 3.5]},
             {"curve": [2.5, 3.5, 2.5, 3]},
             {"curve": [2.5, 2.5, 3, 2.5]}],

            [{"move": [15.5, 5.5]}, {"line": [16.5, 5.5]}],

            [{"move": [16, 2.5]}, {"curve": [16.5, 2.5, 16.5, 3]},
             {"curve": [16.5, 3.5, 16, 3.5]}, {"curve": [15.5, 3.5, 15.5, 3]},
             {"curve": [15.5, 2.5, 16, 2.5]}],

            [{"move": [6, 2.5]}, {"line": [7, 2.5]}, {"curve": [7.5, 2.5, 7.5, 3]},
             {"curve": [7.5, 3.5, 7, 3.5]}, {"line": [6, 3.5]},
             {"curve": [5.5, 3.5, 5.5, 3]}, {"curve": [5.5, 2.5, 6, 2.5]}],

            [{"move": [12, 2.5]}, {"line": [13, 2.5]}, {"curve": [13.5, 2.5, 13.5, 3]},
             {"curve": [13.5, 3.5, 13, 3.5]}, {"line": [12, 3.5]},
             {"curve": [11.5, 3.5, 11.5, 3]}, {"curve": [11.5, 2.5, 12, 2.5]}],

            [{"move": [7.5, 5.5]}, {"line": [9, 5.5]}, {"curve": [9.5, 5.5, 9.5, 6]},
             {"line": [9.5, 7.5]}],
            [{"move": [9.5, 6]}, {"curve": [9.5, 5.5, 10.5, 5.5]},
             {"line": [11.5, 5.5]}],


            [{"move": [5.5, 5.5]}, {"line": [5.5, 7]}, {"curve": [5.5, 7.5, 6, 7.5]},
             {"line": [7.5, 7.5]}],
            [{"move": [6, 7.5]}, {"curve": [5.5, 7.5, 5.5, 8]}, {"line": [5.5, 9.5]}],

            [{"move": [13.5, 5.5]}, {"line": [13.5, 7]},
             {"curve": [13.5, 7.5, 13, 7.5]}, {"line": [11.5, 7.5]}],
            [{"move": [13, 7.5]}, {"curve": [13.5, 7.5, 13.5, 8]},
             {"line": [13.5, 9.5]}],

            [{"move": [0, 11.5]}, {"line": [3, 11.5]}, {"curve": [3.5, 11.5, 3.5, 12]},
             {"line": [3.5, 13]}, {"curve": [3.5, 13.5, 3, 13.5]}, {"line": [1, 13.5]},
             {"curve": [0.5, 13.5, 0.5, 14]}, {"line": [0.5, 17]},
             {"curve": [0.5, 17.5, 1, 17.5]}, {"line": [1.5, 17.5]}],
            [{"move": [1, 17.5]}, {"curve": [0.5, 17.5, 0.5, 18]}, {"line": [0.5, 21]},
             {"curve": [0.5, 21.5, 1, 21.5]}, {"line": [18, 21.5]},
             {"curve": [18.5, 21.5, 18.5, 21]}, {"line": [18.5, 18]},
             {"curve": [18.5, 17.5, 18, 17.5]}, {"line": [17.5, 17.5]}],
            [{"move": [18, 17.5]}, {"curve": [18.5, 17.5, 18.5, 17]},
             {"line": [18.5, 14]}, {"curve": [18.5, 13.5, 18, 13.5]},
             {"line": [16, 13.5]}, {"curve": [15.5, 13.5, 15.5, 13]},
             {"line": [15.5, 12]}, {"curve": [15.5, 11.5, 16, 11.5]},
             {"line": [19, 11.5]}],

            [{"move": [5.5, 11.5]}, {"line": [5.5, 13.5]}],
            [{"move": [13.5, 11.5]}, {"line": [13.5, 13.5]}],

            [{"move": [2.5, 15.5]}, {"line": [3, 15.5]},
             {"curve": [3.5, 15.5, 3.5, 16]}, {"line": [3.5, 17.5]}],
            [{"move": [16.5, 15.5]}, {"line": [16, 15.5]},
             {"curve": [15.5, 15.5, 15.5, 16]}, {"line": [15.5, 17.5]}],

            [{"move": [5.5, 15.5]}, {"line": [7.5, 15.5]}],
            [{"move": [11.5, 15.5]}, {"line": [13.5, 15.5]}],
            
            [{"move": [2.5, 19.5]}, {"line": [5, 19.5]},
             {"curve": [5.5, 19.5, 5.5, 19]}, {"line": [5.5, 17.5]}],
            [{"move": [5.5, 19]}, {"curve": [5.5, 19.5, 6, 19.5]},
             {"line": [7.5, 19.5]}],

            [{"move": [11.5, 19.5]}, {"line": [13, 19.5]},
             {"curve": [13.5, 19.5, 13.5, 19]}, {"line": [13.5, 17.5]}],
            [{"move": [13.5, 19]}, {"curve": [13.5, 19.5, 14, 19.5]},
             {"line": [16.5, 19.5]}],

            [{"move": [7.5, 13.5]}, {"line": [9, 13.5]},
             {"curve": [9.5, 13.5, 9.5, 14]}, {"line": [9.5, 15.5]}],
            [{"move": [9.5, 14]}, {"curve": [9.5, 13.5, 10, 13.5]},
             {"line": [11.5, 13.5]}],

            [{"move": [7.5, 17.5]}, {"line": [9, 17.5]},
             {"curve": [9.5, 17.5, 9.5, 18]}, {"line": [9.5, 19.5]}],
            [{"move": [9.5, 18]}, {"curve": [9.5, 17.5, 10, 17.5]},
             {"line": [11.5, 17.5]}],

            [{"move": [8.5, 9.5]}, {"line": [8, 9.5]}, {"curve": [7.5, 9.5, 7.5, 10]},
             {"line": [7.5, 11]}, {"curve": [7.5, 11.5, 8, 11.5]},
             {"line": [11, 11.5]}, {"curve": [11.5, 11.5, 11.5, 11]},
             {"line": [11.5, 10]}, {"curve": [11.5, 9.5, 11, 9.5]},
             {"line": [10.5, 9.5]}]
        ];

        Object.prototype.clone = function () {
            var i, newObj = (this instanceof Array) ? [] : {};
            for (i in this) {
                if (i === 'clone') {
                    continue;
                }
                if (this[i] && typeof this[i] === "object") {
                    newObj[i] = this[i].clone();
                } else {
                    newObj[i] = this[i];
                }
            }
            return newObj;
        };

        // Utility function to simulate key presses for buttons
        function simulateKeyPress(keyCode) {
            var event = new KeyboardEvent('keydown', {
                keyCode: keyCode,
                which: keyCode,
                bubbles: true
            });
            document.dispatchEvent(event);
        }

        // Update UI displays
        function updateGameDisplay() {
            document.getElementById('speedDisplay').textContent = EducationalGame.ghostSpeedMultiplier.toFixed(1) + 'x';
            document.getElementById('levelDisplay').textContent = '1';
            document.getElementById('gameStats').style.display = 'block';
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            var el = document.getElementById("pacman");
            PACMAN.init(el, "");
            
            // Update display when game starts
            setTimeout(function() {
                updateGameDisplay();
            }, 100);
        });
    </script>
</body>
</html>