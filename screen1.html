<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isaac's Academy - Pre-Assessment</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- External CSS - AFTER Tailwind so our styles take precedence -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- Theme CSS - Load light mode by default -->
    <link rel="stylesheet" href="css/light-mode.css" id="theme-css">
    
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="floating-particles" id="particlesContainer"></div>
    
    <!-- Score Display -->
    <div class="score-display">
        <div class="score-number" id="scoreNumber">0</div>
        <div class="text-xs text-gray-400">Quest Score</div>
    </div>
    
    <div class="flex h-screen desktop-layout">
        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="p-6 border-b border-white/10">
                <div class="flex items-center justify-between">
                    <a href="index.html" class="flex items-center space-x-4 hover:opacity-90 transition-opacity" title="Back to Dashboard" aria-label="Back to Dashboard">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i data-lucide="graduation-cap" class="w-7 h-7 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">MOE Learning Buddy</h1>
                            <p class="text-sm text-gray-400">Pre-Assessment & Learning Path</p>
                        </div>
                    </a>
                    
                    <!-- User Info -->
                    <div class="flex items-center space-x-4">
                        <!-- Theme Toggle -->
                        <button id="themeToggle" class="btn btn-ghost btn-icon" title="Toggle Light/Dark Mode">
                            <i data-lucide="sun" class="w-4 h-4 theme-icon-light"></i>
                            <i data-lucide="moon" class="w-4 h-4 theme-icon-dark hidden"></i>
                        </button>
                        <a href="screen4b.html" class="btn btn-outline" title="Share with Peers">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            Share
                        </a>
                        <a href="index.html" class="btn btn-secondary hidden md:inline-flex" title="Back to Dashboard">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            <span>Back to Dashboard</span>
                        </a>
                        <div class="text-right">
                            <p class="font-bold">Isaac Chen</p>
                            <p class="text-sm text-gray-400">Level 7 â€¢ 1,245 XP</p>
                        </div>
                        <div class="w-12 h-12 rounded-full overflow-hidden">
                            <img src="img/isaac-photo.png" alt="Isaac Chen" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Progress Bar -->
            <div class="p-6 border-b border-white/10 sticky top-0 backdrop-blur supports-[backdrop-filter]:bg-white/5/10">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold">Pre-Assessment Progress</span>
                    <span class="font-bold text-blue-400" id="progressText">3 of 8 completed</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 37.5%"></div>
                </div>
            </div>
            
            <!-- Assessment Content -->
            <main class="p-6 space-y-6">
                
                <!-- Pre-Assessment Section -->
                <div class="academy-card p-8" id="assessmentSection">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="brain" class="w-8 h-8 text-white"></i>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">Science Discovery Timeline Challenge</h2>
                        <p class="text-xl text-gray-300">Drag and drop the scientific discoveries to their correct timeline positions</p>
                    </div>

                    <!-- Timeline -->
                    <div class="timeline-container">
                        <div class="timeline">
                            <div class="timeline-marker">
                                <div class="year-label">1600s</div>
                                <div class="drop-zone" data-period="1600s">Drop Here</div>
                            </div>
                            <div class="timeline-marker">
                                <div class="year-label">1700s</div>
                                <div class="drop-zone" data-period="1700s">Drop Here</div>
                            </div>
                            <div class="timeline-marker">
                                <div class="year-label">1800s</div>
                                <div class="drop-zone" data-period="1800s">Drop Here</div>
                            </div>
                            <div class="timeline-marker">
                                <div class="year-label">1900s</div>
                                <div class="drop-zone" data-period="1900s">Drop Here</div>
                            </div>
                        </div>
                    </div>

                    <!-- Draggable Cards -->
                    <div class="cards-grid">
                        <div class="drag-card" draggable="true" data-answer="1600s">
                            <div class="flex items-start space-x-3">
                                <i data-lucide="microscope" class="w-6 h-6 text-blue-400 mt-1"></i>
                                <div>
                                    <h3>Cell Theory Discovery</h3>
                                    <p>Basic understanding that all living things are made of cells</p>
                                </div>
                            </div>
                        </div>
                        <div class="drag-card" draggable="true" data-answer="1900s">
                            <div class="flex items-start space-x-3">
                                <i data-lucide="dna" class="w-6 h-6 text-green-400 mt-1"></i>
                                <div>
                                    <h3>DNA Structure</h3>
                                    <p>Discovery of the double helix structure of genetic material</p>
                                </div>
                            </div>
                        </div>
                        <div class="drag-card" draggable="true" data-answer="1700s">
                            <div class="flex items-start space-x-3">
                                <i data-lucide="leaf" class="w-6 h-6 text-yellow-400 mt-1"></i>
                                <div>
                                    <h3>Photosynthesis Process</h3>
                                    <p>Understanding how plants convert light into energy</p>
                                </div>
                            </div>
                        </div>
                        <div class="drag-card" draggable="true" data-answer="1800s">
                            <div class="flex items-start space-x-3">
                                <i data-lucide="fish" class="w-6 h-6 text-purple-400 mt-1"></i>
                                <div>
                                    <h3>Evolution Theory</h3>
                                    <p>Natural selection and adaptation of species over time</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center space-x-4 mt-8">
                        <button class="btn btn-neutral" id="hintBtn">
                            <i data-lucide="lightbulb" class="w-4 h-4"></i>
                            Get Hint
                        </button>
                        <button class="btn btn-primary" id="submitBtn" disabled>
                            <i data-lucide="check" class="w-4 h-4"></i>
                            Submit Assessment
                        </button>
                    </div>
                </div>

                <!-- Reusable Glass Modal (Hints) -->
                <div id="glassModal" class="glass-overlay" role="dialog" aria-modal="true" aria-labelledby="glassModalTitle" aria-hidden="true">
                    <div class="glass-modal">
                        <div class="glass-modal-header">
                            <div class="flex items-center gap-2">
                                <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-300"></i>
                                <h3 id="glassModalTitle" class="text-lg font-semibold">Hint</h3>
                            </div>
                            <button id="glassClose" class="glass-close">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="glassBody" class="glass-modal-body"></div>
                        <div class="glass-modal-footer">
                            <button id="glassOk" class="btn btn-primary w-full">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Got it
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Path Generation Section (Hidden initially) -->
                <div class="academy-card p-8 hidden" id="pathSection">
                    
                    <!-- Analyzing State -->
                    <div class="analyzing-state" id="analyzingState">
                        <div class="spinner"></div>
                        <h2 class="text-2xl font-bold mb-2">Analyzing your responses...</h2>
                        <p class="text-gray-300">Creating your personalized learning path based on your strengths</p>
                    </div>

                    <!-- Path Results -->
                    <div class="hidden" id="pathResults">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="route" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-3xl font-bold mb-2">Your Personalized Learning Journey</h2>
                        </div>

                        <!-- Achievement Badge -->
                        <div class="badge-achievement">
                            <div class="badge-icon">
                                <i data-lucide="search" class="w-10 h-10 text-white"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-2">Science Detective Unlocked!</h3>
                            <p class="text-white/90">You've demonstrated strong analytical and problem-solving skills</p>
                        </div>

                        <!-- Learning Path Stats -->
                        <div class="path-stats">
                            <div class="stat-card">
                                <span class="stat-number">85%</span>
                                <span class="stat-label">Foundation Complete</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">12</span>
                                <span class="stat-label">Modules Unlocked</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number">3.5hrs</span>
                                <span class="stat-label">Estimated Time</span>
                            </div>
                        </div>

                        <!-- Recommended Modules -->
                        <div class="modules-grid">
                            <div class="module-card recommended">
                                <div class="module-tag">
                                    <i data-lucide="star" class="w-3 h-3 mr-1"></i>
                                    Recommended
                                </div>
                                <h3 class="text-lg font-bold mb-2 text-white">Advanced Cell Biology</h3>
                                <p class="text-gray-300 mb-4">Deep dive into cellular structures, organelles, and their functions in living organisms</p>
                                <div class="module-meta">
                                    <span><i data-lucide="clock" class="w-4 h-4"></i> 45 min</span>
                                    <span><i data-lucide="signal" class="w-4 h-4"></i> Advanced</span>
                                </div>
                            </div>

                            <div class="module-card">
                                <h3 class="text-lg font-bold mb-2 text-white">Genetics & DNA</h3>
                                <p class="text-gray-300 mb-4">Explore heredity, genetic mechanisms, and molecular biology principles</p>
                                <div class="module-meta">
                                    <span><i data-lucide="clock" class="w-4 h-4"></i> 60 min</span>
                                    <span><i data-lucide="signal" class="w-4 h-4"></i> Intermediate</span>
                                </div>
                            </div>

                            <div class="module-card">
                                <h3 class="text-lg font-bold mb-2 text-white">Evolution & Adaptation</h3>
                                <p class="text-gray-300 mb-4">Study natural selection, species development, and evolutionary biology</p>
                                <div class="module-meta">
                                    <span><i data-lucide="clock" class="w-4 h-4"></i> 50 min</span>
                                    <span><i data-lucide="signal" class="w-4 h-4"></i> Advanced</span>
                                </div>
                            </div>
                        </div>

                        <!-- Start Learning Button -->
                        <div class="text-center mt-8">
                            <button class="btn btn-success btn-lg" id="startLearningBtn">
                                <i data-lucide="play" class="w-5 h-5"></i>
                                Start My Learning Journey
                            </button>
                            <div class="mt-4">
                                <a href="index.html" class="btn btn-secondary">
                                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                    Back to Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Chat Sidebar -->
        <div class="w-80 chat-area flex flex-col">
            <!-- Chat Header -->
            <div class="p-4 border-b border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold">MOE Buddy</h4>
                        <p class="text-xs text-green-400">ðŸŸ¢ Online â€¢ Assessment Mode</p>
                    </div>
                </div>
            </div>
        
            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4">
                <div class="flex justify-start mb-4">
                    <div class="flex items-start space-x-3 max-w-[85%]">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="chat-message">
                            <p class="text-sm text-white">ðŸ§ª Hey Isaac! Ready for the Science Discovery Timeline Challenge? Drag those discoveries to show off your analytical skills - I know you'll ace this quest!</p>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Chat Input -->
            <div class="p-4 border-t border-white/10">
                <div class="flex space-x-3">
                    <textarea 
                        id="chatInput"
                        rows="1"
                        placeholder="" 
                        enterkeyhint="send"
                        class="flex-1 bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-400 transition-colors resize-none max-h-32 leading-5 whitespace-pre-wrap break-words"
                    ></textarea>
                    <button id="sendMessage" class="btn btn-primary btn-icon">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            
                <!-- Quick Action Buttons -->
                <div class="mt-3 space-y-2">
                    <button class="btn btn-ghost w-full justify-start" data-message="Give me a hint about Cell Theory timeline placement">
                        ðŸ”¬ Hint: Cell Theory timeline
                    </button>
                    <button class="btn btn-ghost w-full justify-start" data-message="Explain the scientific method used in these discoveries">
                        ðŸ“š Explain scientific methods
                    </button>
                    <button class="btn btn-ghost w-full justify-start" data-message="What should I focus on for advanced science modules?">
                        ðŸŽ¯ Advanced study tips
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeCss = document.getElementById('theme-css');
        const themeIconLight = document.querySelector('.theme-icon-light');
        const themeIconDark = document.querySelector('.theme-icon-dark');
        
        // Get current theme from localStorage or default to light
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Apply initial theme
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            
            if (theme === 'light') {
                themeCss.href = 'css/light-mode.css';
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
                document.body.setAttribute('data-theme', 'light');
            } else {
                themeCss.href = 'css/dark-mode.css';
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
                document.body.setAttribute('data-theme', 'dark');
            }
        }
        
        // Set initial theme
        setTheme(currentTheme);
        
        // Theme toggle click handler
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            });
        }
        
        // Floating Particles System
        class ParticleSystem {
            constructor() {
                this.container = document.getElementById('particlesContainer');
                this.particles = [];
                this.createParticles();
            }
            
            createParticles() {
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        this.createParticle();
                    }, i * 500);
                }
                
                setInterval(() => {
                    if (this.particles.length < 15) {
                        this.createParticle();
                    }
                }, 2000);
            }
            
            createParticle() {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 2 + 's';
                
                this.container.appendChild(particle);
                this.particles.push(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                        this.particles = this.particles.filter(p => p !== particle);
                    }
                }, 12000);
            }
        }

        // Screen 1 Assessment Demo
        class Screen1Assessment {
            constructor() {
                this.correctAnswers = {
                    'Cell Theory Discovery': '1600s',
                    'DNA Structure': '1900s',
                    'Photosynthesis Process': '1700s',
                    'Evolution Theory': '1800s'
                };
                this.droppedCards = 0;
                this.totalCards = 4;
                this.score = 0;
                this.init();
            }
            
            init() {
                this.setupDragAndDrop();
                this.setupButtons();
                this.setupMOEBuddy();
                this.updateScore(0);
            }
            
            updateScore(points) {
                this.score += points;
                const scoreElement = document.getElementById('scoreNumber');
                if (scoreElement) {
                    scoreElement.textContent = this.score;
                    if (points > 0) {
                        scoreElement.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            scoreElement.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
            }
            
            showAchievementNotification(icon, title, subtitle) {
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-icon">${icon}</div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: bold;">${title}</h3>
                    <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">${subtitle}</p>
                `;
                
                // Append to main content area instead of body for proper positioning
                const mainContent = document.querySelector('.flex-1');
                if (mainContent) {
                    // Make sure main content has relative positioning
                    mainContent.style.position = 'relative';
                    mainContent.appendChild(notification);
                } else {
                    document.body.appendChild(notification);
                }
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
            
            setupDragAndDrop() {
                const cards = document.querySelectorAll('.drag-card');
                const dropZones = document.querySelectorAll('.drop-zone');

                cards.forEach(card => {
                    card.addEventListener('dragstart', this.handleDragStart.bind(this));
                    card.addEventListener('dragend', this.handleDragEnd.bind(this));
                });

                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', this.handleDragOver.bind(this));
                    zone.addEventListener('dragenter', this.handleDragEnter.bind(this));
                    zone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                    zone.addEventListener('drop', this.handleDrop.bind(this));
                });
            }
            
            setupButtons() {
                const submitBtn = document.getElementById('submitBtn');
                const hintBtn = document.getElementById('hintBtn');
                const startLearningBtn = document.getElementById('startLearningBtn');

                submitBtn.addEventListener('click', this.handleSubmit.bind(this));
                hintBtn.addEventListener('click', this.showHint.bind(this));
                
                if (startLearningBtn) {
                    startLearningBtn.addEventListener('click', this.startLearning.bind(this));
                }
            }
            
            setupMOEBuddy() {
                this.moeBuddy = new MOEBuddy();
            }
            
            handleDragStart(e) {
                e.dataTransfer.setData('text/plain', e.target.querySelector('h3').textContent);
                e.target.classList.add('dragging');
            }

            handleDragEnd(e) {
                e.target.classList.remove('dragging');
            }

            handleDragOver(e) {
                e.preventDefault();
            }

            handleDragEnter(e) {
                e.preventDefault();
                e.target.classList.add('drag-over');
            }

            handleDragLeave(e) {
                e.target.classList.remove('drag-over');
            }

            handleDrop(e) {
                e.preventDefault();
                const cardTitle = e.dataTransfer.getData('text/plain');
                const dropZone = e.target.closest('.drop-zone');
                
                if (!dropZone) return;

                dropZone.classList.remove('drag-over');
                
                if (dropZone.classList.contains('filled')) {
                    this.showNotification('This timeline position is already filled!', 'warning');
                    return;
                }

                const droppedCard = document.createElement('div');
                droppedCard.className = 'dropped-card';
                droppedCard.innerHTML = `
                    <div class="card-mini">
                        <h4>${cardTitle}</h4>
                        <button class="remove-btn" onclick="assessment.removeCard(this)">Ã—</button>
                    </div>
                `;

                dropZone.appendChild(droppedCard);
                dropZone.classList.add('filled');
                dropZone.textContent = '';

                const originalCard = Array.from(document.querySelectorAll('.drag-card')).find(
                    card => card.querySelector('h3').textContent === cardTitle
                );
                if (originalCard) {
                    originalCard.style.display = 'none';
                }

                this.droppedCards++;
                this.updateProgress();
                this.updateSubmitButton();
                
                // Add game-like scoring and achievements
                this.updateScore(25);
                this.playDropSound();
                
                // Check for achievements
                if (this.droppedCards === 1) {
                    this.showAchievementNotification('ðŸš€', 'Timeline Started!', 'You placed your first discovery');
                } else if (this.droppedCards === 2) {
                    this.showAchievementNotification('âš¡', 'Getting the Hang of It!', 'Two discoveries placed');
                } else if (this.droppedCards === 3) {
                    this.showAchievementNotification('ðŸ”¥', 'On Fire!', 'Three-piece combo!');
                } else if (this.droppedCards === this.totalCards) {
                    this.showAchievementNotification('ðŸ†', 'Timeline Master!', 'All discoveries placed perfectly');
                    this.updateScore(50); // Bonus for completion
                }
            }
            
            removeCard(button) {
                const droppedCard = button.closest('.dropped-card');
                const cardTitle = button.previousElementSibling.textContent;
                const dropZone = button.closest('.drop-zone');
                
                dropZone.removeChild(droppedCard);
                dropZone.classList.remove('filled');
                dropZone.textContent = 'Drop Here';
                
                const originalCard = Array.from(document.querySelectorAll('.drag-card')).find(
                    card => card.querySelector('h3').textContent === cardTitle
                );
                if (originalCard) {
                    originalCard.style.display = 'block';
                }

                this.droppedCards--;
                this.updateProgress();
                this.updateSubmitButton();
            }
            
            updateProgress() {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const newProgress = ((3 + this.droppedCards) / 8) * 100;
                
                progressFill.style.width = `${newProgress}%`;
                progressText.textContent = `${3 + this.droppedCards} of 8 completed`;
            }
            
            updateSubmitButton() {
                const submitBtn = document.getElementById('submitBtn');
                if (this.droppedCards >= this.totalCards) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            }
            
            playDropSound() {
                try {
                    // Create a subtle drop sound using Web Audio API
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    // Fallback - no sound if Web Audio API fails
                    console.log('Sound not supported');
                }
            }
            
            showHint() {
                const hints = [
                    "ðŸ’¡ Cell Theory was one of the earliest discoveries - think microscopes!",
                    "ðŸ’¡ DNA structure discovery came with modern technology",
                    "ðŸ’¡ Photosynthesis was studied during the Age of Scientific Revolution",
                    "ðŸ’¡ Evolution Theory emerged during the Industrial Revolution era"
                ];
                
                const randomHint = hints[Math.floor(Math.random() * hints.length)];
                this.showGlassModal(randomHint);
                this.updateScore(5); // Small reward for seeking help
            }
            
            handleSubmit() {
                this.showNotification('ðŸŽ¯ Excellent work! Analyzing your responses...', 'success');
                this.updateScore(100); // Big bonus for completion
                this.showAchievementNotification('ðŸŽ“', 'Science Detective!', 'Assessment completed with style!');
                
                // Update progress to 100%
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                progressFill.style.width = '100%';
                progressText.textContent = 'Pre-Assessment: Complete!';
                
                // Show path generation
                setTimeout(() => {
                    this.showPathGeneration();
                }, 1500);
            }
            
            showPathGeneration() {
                const assessmentSection = document.getElementById('assessmentSection');
                const pathSection = document.getElementById('pathSection');
                
                assessmentSection.style.display = 'none';
                pathSection.classList.remove('hidden');
                
                // Show results after analyzing
                setTimeout(() => {
                    const analyzingState = document.getElementById('analyzingState');
                    const pathResults = document.getElementById('pathResults');
                    
                    analyzingState.style.display = 'none';
                    pathResults.classList.remove('hidden');
                }, 3000);
            }
            
            startLearning() {
                this.showNotification('ðŸš€ Starting your personalized learning journey!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-6 right-6 px-4 py-3 rounded-xl shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
                
                const colors = {
                    info: 'bg-blue-500 text-white',
                    success: 'bg-green-500 text-white', 
                    warning: 'bg-yellow-500 text-white'
                };
                
                notification.className += ` ${colors[type]}`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span class="text-sm font-semibold">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                lucide.createIcons();
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // Reusable Glass Modal API
            showGlassModal(message) {
                const overlay = document.getElementById('glassModal');
                const body = document.getElementById('glassBody');
                const closeBtn = document.getElementById('glassClose');
                const okBtn = document.getElementById('glassOk');
                // Pick consistent image based on hint content
                let imgSrc = '';
                if (message.includes('Cell') || message.includes('microscope')) {
                    imgSrc = 'generated_images/hints_people/recraft_20250808_120901_0_a9eee3d1-f6a8-43e0-9aa2-990153b1799f.png';
                } else if (message.includes('DNA')) {
                    imgSrc = 'generated_images/hints_people/recraft_20250808_120907_0_b65c050b-cf1d-4b2b-b7ff-35892209e4a4.png';
                } else if (message.includes('Photosynthesis') || message.includes('plants')) {
                    imgSrc = 'generated_images/hints_people/recraft_20250808_120912_0_484c4263-e2dc-478d-95d8-1e3e50c6f500.png';
                } else if (message.includes('Evolution')) {
                    imgSrc = 'generated_images/hints_people/recraft_20250808_120918_0_4a7ef25d-63f5-4347-b937-b9fad9769514.png';
                }

                // Fun factual tidbits
                const facts = {
                    cell: [
                        'First described by Robert Hooke while studying thin cork slices under a microscope.',
                        'Anton van Leeuwenhoek improved lenses so much he saw bacteria he called "animalcules".',
                        'Modern cell theory: all living things are made of cells; cells come from pre-existing cells.',
                        'The human body contains approximately 37.2 trillion cells of various types.',
                        'Red blood cells live only 120 days, while some brain cells last your entire lifetime.',
                        'Hooke coined the term "cell" because empty plant cells reminded him of monastery cells.',
                        'The largest human cell is the female egg, visible to the naked eye at 0.1mm diameter.',
                        'Bacteria are single-celled organisms that have been on Earth for over 3.5 billion years.',
                        'Plant cells have rigid walls made of cellulose, while animal cells have flexible membranes.',
                        'Some cells like muscle fibers can be several centimeters long despite being single cells.'
                    ],
                    dna: [
                        'The double helix model was famously proposed by Watson and Crick.',
                        'Rosalind Franklin\'s Photo 51 was key evidence for the helix shape.',
                        'Your DNA would stretch to the Sun and back over 600 times if unraveled from all your cells!',
                        'DNA is found in every cell nucleus and contains about 3 billion base pairs in humans.',
                        'You share 99.9% of your DNA with every other human on Earth.',
                        'Humans share about 50% of their DNA with bananas and 60% with fruit flies.',
                        'DNA copying errors occur about once every 10 billion base pairs during replication.',
                        'The "junk DNA" we thought was useless actually helps regulate gene expression.',
                        'DNA can survive thousands of years - we\'ve extracted DNA from ancient Egyptian mummies.',
                        'Every day, your cells repair thousands of DNA damage events from radiation and chemicals.',
                        'The DNA alphabet has only 4 letters (A, T, G, C) but creates infinite biological diversity.'
                    ],
                    photo: [
                        'Photosynthesis converts light energy into chemical energy (glucose).',
                        'Chlorophyll absorbs mostly blue and red light, reflecting green.',
                        'Plants release oxygen as a byproduct â€” your breath thanks them.',
                        'Photosynthesis produces about 460 billion tons of sugar worldwide every year.',
                        'A large tree can produce enough oxygen for 2 people to breathe for a full day.',
                        'Cyanobacteria invented photosynthesis 2.7 billion years ago, creating our oxygen atmosphere.',
                        'Only 1-2% of sunlight energy is actually converted to chemical energy by plants.',
                        'Desert plants like cacti do photosynthesis differently to conserve water.',
                        'Ocean phytoplankton produce more oxygen than all land plants combined.',
                        'Autumn leaves change color when chlorophyll breaks down, revealing other pigments.',
                        'Some plants can switch between different types of photosynthesis based on conditions.'
                    ],
                    evo: [
                        'Natural selection: individuals with helpful traits leave more offspring.',
                        'Darwin studied finches in island habitats to spot variation and adaptation.',
                        'Evolution happens over many generations â€” it is not a straight line.',
                        'Humans and chimpanzees shared a common ancestor about 6-7 million years ago.',
                        'The eye has evolved independently at least 40 times in different animal groups.',
                        'Evolution can happen rapidly: bacteria develop antibiotic resistance in just years.',
                        'Fossil evidence shows life has existed on Earth for at least 3.5 billion years.',
                        'Sexual selection drives traits that help attract mates, like peacock feathers.',
                        'Island species often evolve unique traits due to isolation (like GalÃ¡pagos finches).',
                        'Convergent evolution creates similar solutions: wings in birds, bats, and insects.',
                        'Humans are still evolving: lactose tolerance spread in just 10,000 years.',
                        'Mass extinctions have reset evolution several times, creating new opportunities.'
                    ]
                };

                let factList = facts.cell;
                if (imgSrc.includes('dna')) factList = facts.dna;
                else if (imgSrc.includes('fbcafc86')) factList = facts.photo;
                else if (imgSrc.includes('3413f2d9')) factList = facts.evo;

                const listHtml = factList.map(f => `<li class="mb-1">â€¢ ${f}</li>`).join('');

                body.innerHTML = `
                    <div class="flex items-start gap-5">
                        ${imgSrc ? `<img src="${imgSrc}" alt="Hint Art" class="w-60 h-60 rounded-xl object-cover flex-shrink-0 shadow-2xl"/>` : ''}
                        <div>
                            <p class="text-base text-white mb-3">${message}</p>
                            <ul class="text-sm text-white/80 leading-relaxed">${listHtml}</ul>
                        </div>
                    </div>`;
                overlay.style.display = 'flex';
                const close = () => { overlay.style.display = 'none'; };
                closeBtn.onclick = close;
                okBtn.onclick = close;
                overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
                document.addEventListener('keydown', function handler(e) {
                    if (e.key === 'Escape') { close(); document.removeEventListener('keydown', handler); }
                });
                lucide.createIcons();
            }
        }
        
        // MOE Buddy Chat (same as index.html but adapted for Screen 1)
        class MOEBuddy {
            constructor() {
                this.apiKey = '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';
                this.chatMessages = [];
                this.init();
            }
            
            init() {
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                const sendButton = document.getElementById('sendMessage');
                const chatInput = document.getElementById('chatInput');
                const quickActionBtns = document.querySelectorAll('[data-message]');
                
                sendButton.addEventListener('click', () => this.sendMessage());
                const autoResize = () => {
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 128) + 'px';
                };
                autoResize();
                chatInput.addEventListener('input', autoResize);
                let isComposing = false;
                const isEnter = (evt) => evt.key === 'Enter' || evt.key === 'NumpadEnter' || evt.keyCode === 13 || evt.which === 13;
                chatInput.addEventListener('compositionstart', () => { isComposing = true; });
                chatInput.addEventListener('compositionend', () => { isComposing = false; });
                chatInput.addEventListener('keydown', (e) => {
                    if (isComposing || e.isComposing) return;
                    if (isEnter(e) && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                document.addEventListener('keydown', (e) => {
                    if (document.activeElement === chatInput && !(isComposing || e.isComposing) && isEnter(e) && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                quickActionBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const message = btn.getAttribute('data-message');
                        this.sendQuickMessage(message);
                    });
                });
            }
            
            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                this.addMessage('user', message);
                input.value = '';
                
                // Add empty assistant message for streaming
                const assistantMessageId = this.addMessage('assistant', '');
                
                try {
                    await this.getAIResponseStreaming(message, assistantMessageId);
                } catch (error) {
                    this.updateMessage(assistantMessageId, 'ðŸŽ® Oops! Quest connection failed. Try again, Science Detective!');
                }
            }
            
            sendQuickMessage(message) {
                document.getElementById('chatInput').value = message;
                this.sendMessage();
            }
            
            addMessage(role, message) {
                const chatContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                const messageId = Date.now() + Math.random();
                
                if (role === 'user') {
                    messageDiv.className = 'flex justify-end mb-4';
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500/20 border border-blue-500/40 rounded-lg p-3 max-w-[80%]">
                            <p class="text-sm text-white whitespace-pre-wrap break-words">${message}</p>
                        </div>
                    `;
                } else {
                    messageDiv.className = 'flex justify-start mb-4';
                    messageDiv.innerHTML = `
                        <div class="flex items-start space-x-3 max-w-[85%]">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="chat-message">
                                <p class="text-sm text-white" data-message-id="${messageId}">${message}</p>
                            </div>
                        </div>
                    `;
                }
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                lucide.createIcons();
                
                // Only add to chat history if message has content
                if (message.trim()) {
                    this.chatMessages.push({ role, content: message });
                }
                
                return messageId;
            }
            
            updateMessage(messageId, newContent) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.textContent = newContent;
                    
                    // Update or add to message history
                    const lastAssistantIndex = this.chatMessages.findLastIndex(msg => msg.role === 'assistant');
                    if (lastAssistantIndex !== -1) {
                        this.chatMessages[lastAssistantIndex].content = newContent;
                    } else {
                        this.chatMessages.push({ role: 'assistant', content: newContent });
                    }
                    
                    // Scroll to bottom
                    const chatContainer = document.getElementById('chatMessages');
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            showThinking() {
                const chatContainer = document.getElementById('chatMessages');
                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.className = 'flex justify-start mb-4';
                thinkingDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                            </div>
                            <span class="text-xs text-gray-400">MOE Buddy is thinking...</span>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(thinkingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                lucide.createIcons();
            }
            
            hideThinking() {
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if (thinkingIndicator) {
                    thinkingIndicator.remove();
                }
            }
            
            async getAIResponseStreaming(userMessage, messageId) {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Isaac Learning Platform'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: `You are MOE Buddy, Isaac's hilariously dramatic science quest companion! ðŸ§ªâœ¨

MEET ISAAC CHEN:
- 14-year-old analytical genius from Singapore ðŸ‡¸ðŸ‡¬ 
- Gets WAY too excited about timeline challenges (it's actually adorable)
- Has this weird superpower where he spots cause-effect relationships everywhere
- Currently stress-testing himself with this Timeline Challenge because that's what Isaac does
- Overthinks EVERYTHING but somehow still gets things right (classic Isaac!)

YOUR QUIRKY PERSONALITY:
- ALWAYS call him "Isaac" - make it personal and fun!
- Be dramatically encouraging about his timeline detective skills ðŸ•µï¸
- Give cryptic hints without spoiling answers (make Isaac work for it!)
- Roast him gently when he second-guesses himself
- Use gaming terminology but make it funny ("Isaac, you absolute timeline wizard!")
- Act like every small discovery is the most epic thing ever ðŸŽ‰
- Keep responses witty and supportive (2-4 sentences max)

CURRENT CHALLENGE:
- Isaac is conquering the Science Discovery Timeline Challenge
- Placing Cell Theory, DNA Structure, Photosynthesis, and Evolution in correct time periods  
- Status: Isaac is probably overthinking it right now (as usual!)

ISAAC'S CURRENT PAGE: Timeline Challenge Assessment (screen1.html)
- What Isaac sees: Interactive timeline, draggable discovery cards, drop zones for different time periods
- What Isaac should do: Drag and drop science discoveries to correct time periods on timeline
- Guide Isaac to: Think analytically about when discoveries happened, use hints if stuck, complete the challenge
- Page vibe: Epic timeline detective game where Isaac proves his science history skills
- Special features: Isaac gets XP points, achievements, and game-like feedback for correct placements

Respond as Isaac's enthusiastic, slightly sarcastic science quest sidekick who believes he's destined for timeline greatness! ðŸš€`
                            },
                            ...this.chatMessages,
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.7,
                        max_tokens: 150,
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;

                                try {
                                    const parsed = JSON.parse(data);
                                    const content = parsed.choices?.[0]?.delta?.content;
                                    if (content) {
                                        fullResponse += content;
                                        this.updateMessage(messageId, fullResponse);
                                    }
                                } catch (e) {
                                    // Skip invalid JSON chunks
                                }
                            }
                        }
                    }
                } finally {
                    reader.releaseLock();
                }

                return fullResponse;
            }
        }
        
        // Initialize Screen 1
        const assessment = new Screen1Assessment();
        
        // Initialize Particle System
        const particles = new ParticleSystem();
    </script>
</body>
</html>