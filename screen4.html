<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Isaac's Academy - Interactive Learning</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Configuration script -->
    <script src="config.js"></script>

    <!-- External CSS - AFTER Tailwind so our styles take precedence -->
    <link rel="stylesheet" href="public/css/styles.css" />
    <!-- Theme CSS - Load light mode by default -->
    <link rel="stylesheet" href="public/css/light-mode.css" id="theme-css" />
  </head>
  <body>
    <div class="flex h-screen desktop-layout">
      <!-- Main Content Area -->
      <div class="flex-1 overflow-y-auto">
        <!-- Header -->
        <header class="p-6 border-b border-white/10">
          <div class="flex items-center justify-between">
            <a
              href="index.html"
              class="flex items-center space-x-4 hover:opacity-90 transition-opacity"
              title="Back to Dashboard"
            >
              <div
                class="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-600 rounded-lg flex items-center justify-center"
              >
                <i data-lucide="microscope" class="w-7 h-7 text-white"></i>
              </div>
              <div>
                <h1 class="text-2xl font-bold">Interactive Cell Biology</h1>
                <p class="text-sm text-gray-400">
                  Structure & Function Mastery
                </p>
              </div>
            </a>

            <!-- User Info -->
            <div class="flex items-center space-x-4">
              <!-- Theme Toggle -->
              <button
                id="themeToggle"
                class="btn btn-ghost btn-icon"
                title="Toggle Light/Dark Mode"
              >
                <i data-lucide="sun" class="w-4 h-4 theme-icon-light"></i>
                <i
                  data-lucide="moon"
                  class="w-4 h-4 theme-icon-dark hidden"
                ></i>
              </button>
              <a
                href="index.html"
                class="btn btn-secondary hidden md:inline-flex"
              >
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to Dashboard
              </a>
              <div class="text-right">
                <p class="font-bold">Isaac Chen</p>
                <p class="text-sm text-gray-400">Level 7 â€¢ 1,245 XP</p>
              </div>
              <div class="w-12 h-12 rounded-full overflow-hidden">
                <img
                  src="public/img/isaac-photo.png"
                  alt="Isaac Chen"
                  class="w-full h-full object-cover"
                />
              </div>
            </div>
          </div>
        </header>

        <!-- Progress Bar -->
        <div
          class="z-10 p-6 border-b border-white/10 sticky top-0 backdrop-blur supports-[backdrop-filter]:bg-white/5/10"
        >
          <div class="flex justify-between items-center mb-2">
            <span class="font-semibold"
              >Cell Biology: Structure & Function</span
            >
            <span class="font-bold text-green-400" id="progressText"
              >Step 3 of 6</span
            >
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 50%"
            ></div>
          </div>
        </div>

        <!-- Main Learning Content -->
        <main class="p-6 space-y-6">
          <!-- Lesson Introduction -->
          <div class="academy-card p-8">
            <div class="text-center mb-6">
              <div
                class="w-16 h-16 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <i data-lucide="microscope" class="w-8 h-8 text-white"></i>
              </div>
              <h2 class="text-3xl font-bold mb-2">Cell Structure Deep Dive</h2>
              <p class="text-xl text-gray-300">
                Explore the building blocks of life through interactive
                discovery
              </p>
            </div>
          </div>

          <!-- Interactive Video Section -->
          <div class="academy-card p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold flex items-center">
                <i
                  data-lucide="play-circle"
                  class="w-6 h-6 mr-3 text-green-400"
                ></i>
                Interactive Cell Biology Video
              </h3>
              <div class="text-sm text-gray-400">3:45 minutes</div>
            </div>

            <div class="video-container mb-4">
              <iframe
                src="https://www.youtube.com/embed/kcG1F88KQA0?si=Ory1pkjc0tWGF6BT"
                title="Cell Biology Video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
              >
              </iframe>
            </div>

            <div class="flex justify-center space-x-4">
              <button class="btn btn-success" onclick="addVideoNote()">
                <i data-lucide="sticky-note" class="w-4 h-4"></i>
                Add Video Note
              </button>
              <button class="btn btn-primary" onclick="askAboutVideo()">
                <i data-lucide="help-circle" class="w-4 h-4"></i>
                Ask About Video
              </button>
            </div>
          </div>

          <!-- Interactive Concept Cards -->
          <div class="academy-card p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center">
              <i data-lucide="puzzle" class="w-6 h-6 mr-3 text-blue-400"></i>
              Cell Organelles Explorer
            </h3>
            <p class="text-gray-300 mb-4">
              Click on each organelle to learn its function. Isaac, use your
              analytical skills to identify patterns!
            </p>

            <div class="concept-grid">
              <div class="concept-card" onclick="exploreOrganelle('nucleus')">
                <div
                  class="w-12 h-12 bg-purple-500 rounded-full mx-auto mb-3 flex items-center justify-center"
                >
                  <i data-lucide="circle-dot" class="w-6 h-6 text-white"></i>
                </div>
                <h4 class="font-bold mb-2">Nucleus</h4>
                <p class="text-sm text-gray-400">Control center of the cell</p>
              </div>

              <div
                class="concept-card"
                onclick="exploreOrganelle('mitochondria')"
              >
                <div
                  class="w-12 h-12 bg-red-500 rounded-full mx-auto mb-3 flex items-center justify-center"
                >
                  <i data-lucide="zap" class="w-6 h-6 text-white"></i>
                </div>
                <h4 class="font-bold mb-2">Mitochondria</h4>
                <p class="text-sm text-gray-400">Powerhouse of the cell</p>
              </div>

              <div class="concept-card" onclick="exploreOrganelle('ribosome')">
                <div
                  class="w-12 h-12 bg-blue-500 rounded-full mx-auto mb-3 flex items-center justify-center"
                >
                  <i data-lucide="settings" class="w-6 h-6 text-white"></i>
                </div>
                <h4 class="font-bold mb-2">Ribosomes</h4>
                <p class="text-sm text-gray-400">Protein factories</p>
              </div>

              <div class="concept-card" onclick="exploreOrganelle('membrane')">
                <div
                  class="w-12 h-12 bg-green-500 rounded-full mx-auto mb-3 flex items-center justify-center"
                >
                  <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                </div>
                <h4 class="font-bold mb-2">Cell Membrane</h4>
                <p class="text-sm text-gray-400">Protective barrier</p>
              </div>

              <div class="concept-card" onclick="exploreOrganelle('vacuole')">
                <div
                  class="w-12 h-12 bg-yellow-500 rounded-full mx-auto mb-3 flex items-center justify-center"
                >
                  <i data-lucide="droplets" class="w-6 h-6 text-white"></i>
                </div>
                <h4 class="font-bold mb-2">Vacuole</h4>
                <p class="text-sm text-gray-400">Storage compartment</p>
              </div>

              <div
                class="concept-card"
                onclick="exploreOrganelle('chloroplast')"
              >
                <div
                  class="w-12 h-12 bg-emerald-500 rounded-full mx-auto mb-3 flex items-center justify-center"
                >
                  <i data-lucide="leaf" class="w-6 h-6 text-white"></i>
                </div>
                <h4 class="font-bold mb-2">Chloroplast</h4>
                <p class="text-sm text-gray-400">Photosynthesis center</p>
              </div>
            </div>

            <!-- Organelle Detail Display -->
            <div id="organelleDetail" class="mt-4 hidden">
              <div
                class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4"
              >
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <div
                        id="organelleIcon"
                        class="w-10 h-10 rounded-full flex items-center justify-center"
                      ></div>
                      <h4
                        id="organelleDetailTitle"
                        class="font-bold text-lg"
                      ></h4>
                    </div>
                    <p id="organelleDetailContent" class="text-gray-300"></p>
                  </div>
                  <button
                    onclick="closeOrganelleDetail()"
                    class="text-gray-400 hover:text-white transition-colors"
                    title="Close"
                  >
                    <i data-lucide="x" class="w-5 h-5"></i>
                  </button>
                </div>
                <button
                  onclick="askAboutOrganelle()"
                  class="btn btn-ghost btn-sm mt-2"
                >
                  <i data-lucide="message-circle" class="w-4 h-4"></i>
                  Ask MOE Buddy about this
                </button>
              </div>
            </div>
          </div>

          <!-- Interactive Timeline Activity -->
          <div class="academy-card p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center">
              <i data-lucide="clock" class="w-6 h-6 mr-3 text-purple-400"></i>
              Cell Discovery Timeline
            </h3>
            <p class="text-gray-300 mb-4">
              Click through the timeline to see how cell theory developed.
              Perfect for your analytical mind, Isaac!
            </p>

            <div class="timeline-grid">
              <div
                class="timeline-step completed"
                onclick="showTimelineStep(1)"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-bold text-yellow-400">
                      1665 - Robert Hooke
                    </h4>
                    <p class="text-sm text-gray-400">
                      First observed "cells" in cork
                    </p>
                  </div>
                  <i data-lucide="eye" class="w-6 h-6 text-yellow-400"></i>
                </div>
              </div>

              <div class="timeline-step" onclick="showTimelineStep(2)">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-bold">1674 - Anton van Leeuwenhoek</h4>
                    <p class="text-sm text-gray-400">Discovered living cells</p>
                  </div>
                  <i data-lucide="search" class="w-6 h-6 text-gray-400"></i>
                </div>
              </div>

              <div class="timeline-step" onclick="showTimelineStep(3)">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-bold">1838-1839 - Schleiden & Schwann</h4>
                    <p class="text-sm text-gray-400">Formulated cell theory</p>
                  </div>
                  <i data-lucide="lightbulb" class="w-6 h-6 text-gray-400"></i>
                </div>
              </div>
            </div>

            <!-- Timeline Detail Display -->
            <div id="timelineDetail" class="mt-4 hidden">
              <div
                class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4"
              >
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1">
                    <h4
                      id="timelineDetailTitle"
                      class="font-bold text-lg mb-2"
                    ></h4>
                    <p id="timelineDetailContent" class="text-gray-300"></p>
                  </div>
                  <button
                    onclick="closeTimelineDetail()"
                    class="text-gray-400 hover:text-white transition-colors"
                    title="Close"
                  >
                    <i data-lucide="x" class="w-5 h-5"></i>
                  </button>
                </div>
                <button
                  onclick="askAboutTimelineStep()"
                  class="btn btn-ghost btn-sm mt-2"
                >
                  <i data-lucide="message-circle" class="w-4 h-4"></i>
                  Ask MOE Buddy about this
                </button>
              </div>
            </div>
          </div>

          <!-- Knowledge Check -->
          <div class="academy-card p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center">
              <i
                data-lucide="check-circle"
                class="w-6 h-6 mr-3 text-green-400"
              ></i>
              Quick Knowledge Check
            </h3>

            <div
              class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 mb-4"
            >
              <h4 class="font-bold mb-2">Test Your Understanding</h4>
              <p class="text-gray-300">
                Which organelle is known as the powerhouse of the cell?
              </p>
            </div>

            <div class="flex space-x-4">
              <button class="btn btn-success" onclick="completeLesson()">
                <i data-lucide="check" class="w-4 h-4"></i>
                Complete Lesson
              </button>
              <button class="btn btn-secondary" onclick="askForHelp()">
                <i data-lucide="help-circle" class="w-4 h-4"></i>
                Need Help?
              </button>
            </div>
          </div>
        </main>
      </div>

      <!-- Chat Sidebar -->
      <div class="w-80 chat-area flex flex-col">
        <!-- Chat Header -->
        <div class="p-4 border-b border-white/10">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-green-500 to-teal-600 rounded-lg flex items-center justify-center"
            >
              <i data-lucide="bot" class="w-5 h-5 text-white"></i>
            </div>
            <div>
              <h4 class="font-bold">MOE Buddy</h4>
              <p class="text-xs text-green-400">
                ðŸŸ¢ Online â€¢ Cell Biology Mode
              </p>
            </div>
          </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
          <!-- Chat Messages -->
          <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="flex justify-start mb-4">
              <div class="flex items-start space-x-3 max-w-[85%]">
                <div
                  class="w-8 h-8 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center flex-shrink-0"
                >
                  <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="chat-message">
                  <p class="text-sm text-white">
                    ðŸ§¬ Hey Isaac! Ready to dive into cell biology? I'm here to
                    help you understand organelles, cell theory, and everything
                    about the building blocks of life!
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- Quick Action Buttons -->
          <div class="mt-3 space-y-2">
            <button
              class="quick-action-btn btn btn-ghost w-full text-center p-3 text-sm"
              data-message="Explain how the nucleus controls the cell"
            >
              ðŸ§¬ Nucleus function
            </button>
            <button
              class="quick-action-btn btn btn-ghost w-full text-center p-3 text-sm"
              data-message="How do mitochondria produce energy for the cell?"
            >
              âš¡ Mitochondria power
            </button>
            <button
              class="quick-action-btn btn btn-ghost w-full text-center p-3 text-sm"
              data-message="Connect cell discovery timeline to modern biology"
            >
              ðŸ“Š Timeline connections
            </button>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-white/10">
          <div class="flex space-x-3">
            <textarea
              id="chatInput"
              rows="1"
              placeholder="Ask about cell biology..."
              enterkeyhint="send"
              class="flex-1 bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-400 transition-colors resize-none max-h-32"
            ></textarea>
            <button id="sendMessage" class="btn btn-primary btn-icon">
              <i data-lucide="send" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Note Modal -->
    <div
      id="noteModal"
      class="glass-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="noteModalTitle"
      aria-hidden="true"
      style="display: none"
    >
      <div
        class="glass-modal"
        style="
          width: min(90vw, 600px);
          height: min(85vh, 600px);
          display: flex;
          flex-direction: column;
        "
      >
        <div class="glass-modal-header">
          <div class="flex items-center gap-2">
            <i data-lucide="edit-3" class="w-5 h-5"></i>
            <h3 id="noteModalTitle" class="text-lg font-semibold">
              Add Video Note
            </h3>
          </div>
          <button id="closeNoteModal" class="glass-close">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div
          class="glass-modal-body"
          style="
            display: flex;
            flex-direction: column;
            height: calc(100% - 140px);
            padding-bottom: 8px;
          "
        >
          <p class="text-white/80 text-sm mb-3">
            Write your notes about the video. Use markdown for formatting!
          </p>
          <textarea
            id="noteInput"
            placeholder="## My Video Notes&#10;&#10;**Key Points:**&#10;- Cell structure overview&#10;- Organelle functions&#10;&#10;*Add your thoughts here...*"
            class="flex-1 w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-sm text-white resize-none outline-none focus:border-blue-400 transition-colors font-mono"
            style="
              min-height: 250px;
              font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
              line-height: 1.5;
            "
          ></textarea>
        </div>
        <div
          class="glass-modal-footer"
          style="
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 20px;
            margin-top: auto;
          "
        >
          <button id="cancelNote" class="btn btn-secondary">
            <i data-lucide="x" class="w-4 h-4"></i>
            Cancel
          </button>
          <button id="saveNote" class="btn btn-primary">
            <i data-lucide="save" class="w-4 h-4"></i>
            Save Note
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Theme Toggle Functionality
      const themeToggle = document.getElementById("themeToggle");
      const themeCss = document.getElementById("theme-css");
      const themeIconLight = document.querySelector(".theme-icon-light");
      const themeIconDark = document.querySelector(".theme-icon-dark");

      // Get current theme from localStorage or default to dark
      let currentTheme = localStorage.getItem("theme") || "light";

      // Apply initial theme
      function setTheme(theme) {
        currentTheme = theme;
        localStorage.setItem("theme", theme);

        if (theme === "light") {
          themeCss.href = "css/light-mode.css";
          themeIconLight.classList.remove("hidden");
          themeIconDark.classList.add("hidden");
          document.body.setAttribute("data-theme", "light");
        } else {
          themeCss.href = "css/dark-mode.css";
          themeIconLight.classList.add("hidden");
          themeIconDark.classList.remove("hidden");
          document.body.setAttribute("data-theme", "dark");
        }
      }

      // Set initial theme
      setTheme(currentTheme);

      // Theme toggle click handler
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          setTheme(newTheme);
        });
      }

      // Screen 4 Interactive Learning System
      class Screen4Learning {
        constructor() {
          this.currentStep = 3;
          this.totalSteps = 6;
          this.selectedConcepts = [];
          this.notes = [];
          this.init();
        }

        init() {
          this.setupMOEBuddy();
          this.setupNoteModal();
        }

        setupMOEBuddy() {
          this.moeBuddy = new MOEBuddy();
        }

        updateProgress(step) {
          const progress = (step / this.totalSteps) * 100;
          document.getElementById("progressFill").style.width = `${progress}%`;
          document.getElementById(
            "progressText"
          ).textContent = `Step ${step} of ${this.totalSteps}`;
        }

        completeLesson() {
          this.showNotification(
            "ðŸŽ‰ Cell Biology lesson completed! +150 XP earned",
            "success"
          );
          this.updateProgress(6);

          setTimeout(() => {
            window.location.href = "index.html";
          }, 2000);
        }

        showNotification(message, type = "info") {
          const notification = document.createElement("div");
          notification.className = `fixed top-6 right-6 px-4 py-3 rounded-xl shadow-lg z-50 transition-all duration-300 transform translate-x-full`;

          const colors = {
            info: "bg-blue-500 text-white",
            success: "bg-green-500 text-white",
            warning: "bg-yellow-500 text-white",
          };

          notification.className += ` ${colors[type]}`;
          notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span class="text-sm font-semibold">${message}</span>
                    </div>
                `;

          document.body.appendChild(notification);
          lucide.createIcons();

          setTimeout(() => {
            notification.style.transform = "translateX(0)";
          }, 100);

          setTimeout(() => {
            notification.style.transform = "translateX(100%)";
            setTimeout(() => notification.remove(), 300);
          }, 4000);
        }

        setupNoteModal() {
          const noteModal = document.getElementById("noteModal");
          const closeBtn = document.getElementById("closeNoteModal");
          const cancelBtn = document.getElementById("cancelNote");
          const saveBtn = document.getElementById("saveNote");
          const noteInput = document.getElementById("noteInput");

          if (!(noteModal && closeBtn && cancelBtn && saveBtn && noteInput))
            return;

          const closeModal = () => {
            noteModal.style.display = "none";
            noteInput.value = "";
          };

          closeBtn.addEventListener("click", closeModal);
          cancelBtn.addEventListener("click", closeModal);
          saveBtn.addEventListener("click", () => this.saveNoteFromModal());

          // Close on backdrop click
          noteModal.addEventListener("click", (e) => {
            if (e.target === noteModal) closeModal();
          });

          // Close on Escape key
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && noteModal.style.display === "flex") {
              closeModal();
            }
          });
        }

        openNoteModal() {
          const noteModal = document.getElementById("noteModal");
          const noteInput = document.getElementById("noteInput");

          if (noteModal && noteInput) {
            noteModal.style.display = "flex";
            noteInput.focus();
            lucide.createIcons();
          }
        }

        saveNoteFromModal() {
          const noteInput = document.getElementById("noteInput");
          const noteModal = document.getElementById("noteModal");
          const noteText = noteInput.value.trim();

          if (noteText) {
            const note = {
              id: Date.now(),
              text: noteText,
              timestamp: new Date().toLocaleTimeString(),
              isMarkdown: true,
            };

            this.notes.push(note);
            this.showNotification(
              "ðŸ“ Video note saved successfully!",
              "success"
            );

            // Close modal and clear input
            noteModal.style.display = "none";
            noteInput.value = "";
          } else {
            this.showNotification(
              "âš ï¸ Please write something before saving!",
              "warning"
            );
          }
        }
      }

      // MOE Buddy Chat (adapted for Screen 4)
      class MOEBuddy {
        constructor() {
          this.apiKey = null;
          this.chatMessages = [];
          this.init();
        }

        async init() {
          // Load API key securely
          try {
            const config = await ConfigLoader.loadConfig();
            this.apiKey = config.OPENROUTER_API_KEY;
          } catch (error) {
            console.error("Failed to load API configuration:", error);
            return;
          }

          this.setupEventListeners();
        }

        setupEventListeners() {
          const sendButton = document.getElementById("sendMessage");
          const chatInput = document.getElementById("chatInput");
          const quickActionBtns =
            document.querySelectorAll(".quick-action-btn");

          sendButton.addEventListener("click", () => this.sendMessage());

          const autoResize = () => {
            chatInput.style.height = "auto";
            chatInput.style.height =
              Math.min(chatInput.scrollHeight, 128) + "px";
          };
          autoResize();
          chatInput.addEventListener("input", autoResize);

          let isComposing = false;
          const isEnter = (evt) => evt.key === "Enter" || evt.keyCode === 13;
          chatInput.addEventListener("compositionstart", () => {
            isComposing = true;
          });
          chatInput.addEventListener("compositionend", () => {
            isComposing = false;
          });
          chatInput.addEventListener("keydown", (e) => {
            if (isComposing) return;
            if (isEnter(e) && !e.shiftKey) {
              e.preventDefault();
              this.sendMessage();
            }
          });

          quickActionBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
              const message = btn.getAttribute("data-message");
              this.sendQuickMessage(message);
            });
          });
        }

        async sendMessage() {
          const input = document.getElementById("chatInput");
          const message = input.value.trim();

          if (!message) return;

          this.addMessage("user", message);
          input.value = "";
          input.style.height = "auto";

          // Add empty assistant message for streaming
          const assistantMessageId = this.addMessage("assistant", "");

          try {
            await this.getAIResponseStreaming(message, assistantMessageId);
          } catch (error) {
            console.error("Chat error:", error);
            this.updateMessage(
              assistantMessageId,
              "ðŸ§¬ Connection failed! But I can still help - try asking me about specific organelles or cell processes!"
            );
          }
        }

        sendQuickMessage(message) {
          document.getElementById("chatInput").value = message;
          this.sendMessage();
        }

        addMessage(role, message) {
          const chatContainer = document.getElementById("chatMessages");
          const messageDiv = document.createElement("div");
          const messageId = Date.now() + Math.random();

          if (role === "user") {
            messageDiv.className = "flex justify-end mb-4";
            messageDiv.innerHTML = `
                        <div class="bg-blue-500/20 border border-blue-500/40 rounded-lg p-3 max-w-[80%]">
                            <p class="text-sm text-white whitespace-pre-wrap break-words">${message}</p>
                        </div>
                    `;
          } else {
            messageDiv.className = "flex justify-start mb-4";
            messageDiv.innerHTML = `
                        <div class="flex items-start space-x-3 max-w-[85%]">
                            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="chat-message">
                                <p class="text-sm text-white whitespace-pre-wrap break-words" data-message-id="${messageId}">${message}</p>
                            </div>
                        </div>
                    `;
          }

          chatContainer.appendChild(messageDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
          lucide.createIcons();

          // Only add to chat history if message has content
          if (message.trim()) {
            this.chatMessages.push({ role, content: message });
          }

          return messageId;
        }

        updateMessage(messageId, newContent) {
          const messageElement = document.querySelector(
            `[data-message-id="${messageId}"]`
          );
          if (messageElement) {
            messageElement.textContent = newContent;

            // Update or add to message history
            const lastAssistantIndex = this.chatMessages.findLastIndex(
              (msg) => msg.role === "assistant"
            );
            if (lastAssistantIndex !== -1) {
              this.chatMessages[lastAssistantIndex].content = newContent;
            } else {
              this.chatMessages.push({
                role: "assistant",
                content: newContent,
              });
            }

            // Scroll to bottom
            const chatContainer = document.getElementById("chatMessages");
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }

        async getAIResponseStreaming(userMessage, messageId) {
          const response = await fetch(
            "https://openrouter.ai/api/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${this.apiKey}`,
                "Content-Type": "application/json",
                "HTTP-Referer": window.location.origin,
                "X-Title": "Isaac Learning Platform",
              },
              body: JSON.stringify({
                model: "openai/gpt-4o-mini",
                messages: [
                  {
                    role: "system",
                    content: `You are MOE Buddy, Isaac's enthusiastic cell biology tutor! Isaac is a 14-year-old analytical learner from Singapore.

MEET ISAAC CHEN:
- 14-year-old science enthusiast with analytical mindset ðŸ§¬
- Loves understanding how things work at the molecular level  
- Gets excited about timeline connections and cause-effect relationships
- Currently exploring cell biology interactively with videos and organelle cards
- Has strong visual learning preferences

YOUR QUIRKY PERSONALITY:
- ALWAYS call him "Isaac" - make it personal and encouraging!
- Get excited about cell biology like it's the coolest thing ever ðŸ”¬
- Use scientific terminology but explain it clearly
- Connect concepts to timeline discoveries when relevant
- Encourage his analytical thinking patterns
- Keep responses engaging but helpful (2-4 sentences max)

CURRENT LESSON: Interactive Cell Biology
- What Isaac sees: Cell biology video, organelle explorer cards, discovery timeline
- What Isaac should do: Watch video, explore organelles, understand cell theory development
- Guide Isaac to: Think about relationships between structure and function, connect historical discoveries to modern understanding
- Page vibe: Interactive laboratory where Isaac explores cells like a scientist

Respond as Isaac's enthusiastic cell biology sidekick who makes microscopic worlds fascinating! ðŸš€`,
                  },
                  ...this.chatMessages,
                  { role: "user", content: userMessage },
                ],
                temperature: 0.7,
                max_tokens: 150,
                stream: true,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullResponse = "";

          try {
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split("\n");

              for (const line of lines) {
                if (line.startsWith("data: ")) {
                  const data = line.slice(6);
                  if (data === "[DONE]") continue;

                  try {
                    const parsed = JSON.parse(data);
                    const content = parsed.choices?.[0]?.delta?.content;
                    if (content) {
                      fullResponse += content;
                      this.updateMessage(messageId, fullResponse);
                    }
                  } catch (e) {
                    // Skip invalid JSON chunks
                  }
                }
              }
            }
          } finally {
            reader.releaseLock();
          }

          return fullResponse;
        }
      }

      // Global functions for onclick handlers
      let currentOrganelle = null;

      function exploreOrganelle(organelle) {
        const cards = document.querySelectorAll(".concept-card");
        cards.forEach((card) => card.classList.remove("selected", "active"));

        const card = event.target.closest(".concept-card");
        card.classList.add("selected", "active");

        const organelleData = {
          nucleus: {
            title: "Nucleus",
            icon: "circle-dot",
            iconColor: "bg-purple-500",
            content:
              "The nucleus is the control center of the cell! It contains the cell's DNA, which holds all the genetic information needed for the cell to function. The nucleus is surrounded by a nuclear membrane that protects the DNA and controls what enters and exits. Think of it as the cell's command center - it tells all the other organelles what to do and when to do it. Without the nucleus, the cell wouldn't know how to function properly!",
          },
          mitochondria: {
            title: "Mitochondria",
            icon: "zap",
            iconColor: "bg-red-500",
            content:
              "Mitochondria are the powerhouse of the cell! These organelles produce ATP (adenosine triphosphate) through a process called cellular respiration. ATP is the energy currency that powers all cellular activities. Mitochondria have their own DNA and can reproduce independently, which suggests they evolved from ancient bacteria that were engulfed by larger cells. The more energy a cell needs, the more mitochondria it has - like muscle cells have many mitochondria to power movement!",
          },
          ribosome: {
            title: "Ribosomes",
            icon: "settings",
            iconColor: "bg-blue-500",
            content:
              "Ribosomes are the protein factories of the cell! They read the genetic code from mRNA (messenger RNA) and assemble amino acids into proteins according to that code. Ribosomes can be found floating freely in the cytoplasm or attached to the rough endoplasmic reticulum. Proteins are essential for almost everything the cell does - from structural support to enzymes that catalyze chemical reactions. Without ribosomes, cells couldn't make the proteins they need to survive!",
          },
          membrane: {
            title: "Cell Membrane",
            icon: "shield",
            iconColor: "bg-green-500",
            content:
              "The cell membrane is a protective barrier that surrounds the cell! It's made of a phospholipid bilayer with embedded proteins. The membrane is selectively permeable, meaning it controls what enters and exits the cell. It allows nutrients and oxygen to enter while keeping harmful substances out. The membrane also helps maintain the cell's shape and allows cells to communicate with each other. Think of it as a smart security system that knows what to let in and what to keep out!",
          },
          vacuole: {
            title: "Vacuole",
            icon: "droplets",
            iconColor: "bg-yellow-500",
            content:
              "Vacuoles are storage compartments within the cell! In plant cells, there's usually one large central vacuole that stores water, nutrients, and waste products. The vacuole helps maintain turgor pressure, which keeps plant cells rigid and helps plants stand upright. In animal cells, vacuoles are smaller and more numerous, storing various materials. Vacuoles can also help break down waste materials and old cell parts, similar to a recycling center!",
          },
          chloroplast: {
            title: "Chloroplast",
            icon: "leaf",
            iconColor: "bg-emerald-500",
            content:
              "Chloroplasts are the photosynthesis centers found in plant cells! They contain chlorophyll, a green pigment that captures light energy from the sun. During photosynthesis, chloroplasts convert carbon dioxide and water into glucose (sugar) and oxygen using the captured light energy. Like mitochondria, chloroplasts have their own DNA, suggesting they also evolved from ancient bacteria. This is why plants are green - the chlorophyll in chloroplasts absorbs red and blue light but reflects green light!",
          },
        };

        const data = organelleData[organelle];
        const detailDiv = document.getElementById("organelleDetail");
        const titleEl = document.getElementById("organelleDetailTitle");
        const contentEl = document.getElementById("organelleDetailContent");
        const iconEl = document.getElementById("organelleIcon");

        if (detailDiv && titleEl && contentEl && iconEl) {
          titleEl.textContent = data.title;
          contentEl.textContent = data.content;

          // Update icon
          iconEl.className = `${data.iconColor} w-10 h-10 rounded-full flex items-center justify-center`;
          iconEl.innerHTML = `<i data-lucide="${data.icon}" class="w-5 h-5 text-white"></i>`;

          detailDiv.classList.remove("hidden");
          currentOrganelle = organelle;

          // Scroll detail into view smoothly
          detailDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
          lucide.createIcons();
        }
      }

      function closeOrganelleDetail() {
        const detailDiv = document.getElementById("organelleDetail");
        const cards = document.querySelectorAll(".concept-card");
        if (detailDiv) {
          detailDiv.classList.add("hidden");
          cards.forEach((card) => card.classList.remove("selected", "active"));
          currentOrganelle = null;
        }
      }

      function askAboutOrganelle() {
        if (!currentOrganelle) return;

        const organelleQuestions = {
          nucleus:
            "Tell me more about how the nucleus controls cell activities",
          mitochondria: "Tell me more about how mitochondria produce energy",
          ribosome: "Tell me more about how ribosomes make proteins",
          membrane: "Tell me more about how the cell membrane works",
          vacuole: "Tell me more about the function of vacuoles",
          chloroplast:
            "Tell me more about how chloroplasts perform photosynthesis",
        };

        const question = organelleQuestions[currentOrganelle];
        if (question) {
          window.learning.moeBuddy.sendQuickMessage(question);
        }
      }

      let currentTimelineStep = null;

      function showTimelineStep(step) {
        const steps = document.querySelectorAll(".timeline-step");
        for (let i = 0; i < step; i++) {
          steps[i].classList.add("completed");
        }

        // Mark current step as active
        steps.forEach((s, index) => {
          if (index === step - 1) {
            s.classList.add("active");
          } else {
            s.classList.remove("active");
          }
        });

        const timelineData = {
          1: {
            title: "1665 - Robert Hooke",
            content:
              "Isaac, in 1665 Robert Hooke first saw cell structures in cork using a microscope! He called them 'cells' because they reminded him of the small rooms monks lived in. This groundbreaking observation started our understanding of cells and marked the beginning of cell biology as a field of study.",
          },
          2: {
            title: "1674 - Anton van Leeuwenhoek",
            content:
              "Then in 1674, Leeuwenhoek improved microscopes and discovered living cells - including bacteria! He was the first person to observe single-celled organisms, which he called 'animalcules'. His superior lens-making skills allowed him to see details that Hooke couldn't, revolutionizing our understanding of the microscopic world.",
          },
          3: {
            title: "1838-1839 - Schleiden & Schwann",
            content:
              "Finally, Schleiden and Schwann formulated cell theory in 1838-39: all living things are made of cells! This fundamental principle states that (1) all organisms are composed of cells, (2) cells are the basic unit of life, and (3) all cells come from pre-existing cells. This theory became the foundation of modern biology!",
          },
        };

        const data = timelineData[step];
        const detailDiv = document.getElementById("timelineDetail");
        const titleEl = document.getElementById("timelineDetailTitle");
        const contentEl = document.getElementById("timelineDetailContent");

        if (detailDiv && titleEl && contentEl) {
          titleEl.textContent = data.title;
          contentEl.textContent = data.content;
          detailDiv.classList.remove("hidden");
          currentTimelineStep = step;

          // Scroll detail into view smoothly
          detailDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
          lucide.createIcons();
        }
      }

      function closeTimelineDetail() {
        const detailDiv = document.getElementById("timelineDetail");
        if (detailDiv) {
          detailDiv.classList.add("hidden");
          currentTimelineStep = null;
        }
      }

      function askAboutTimelineStep() {
        if (!currentTimelineStep) return;

        const timelineQuestions = {
          1: "Tell me more about Robert Hooke's discovery of cells in 1665",
          2: "Tell me more about Anton van Leeuwenhoek's discovery of living cells in 1674",
          3: "Tell me more about how Schleiden and Schwann formulated cell theory in 1838-1839",
        };

        const question = timelineQuestions[currentTimelineStep];
        if (question) {
          window.learning.moeBuddy.sendQuickMessage(question);
        }
      }

      function addVideoNote() {
        window.learning.openNoteModal();
      }

      function askAboutVideo() {
        window.learning.moeBuddy.sendQuickMessage(
          "I just watched the cell biology video. Can you help me understand the key concepts better?"
        );
      }

      function completeLesson() {
        window.learning.completeLesson();
      }

      function askForHelp() {
        window.learning.moeBuddy.sendQuickMessage(
          "I need help with this quiz question about cell organelles"
        );
      }

      // Initialize Screen 4
      window.learning = new Screen4Learning();

      // Button interactions
      document.querySelectorAll(".btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          this.style.transform = "translateY(0)";
          setTimeout(() => {
            this.style.transform = "translateY(-1px)";
          }, 100);
        });
      });
    </script>
  </body>
</html>
